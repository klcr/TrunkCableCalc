# 低圧幹線ケーブル計算ツール — 機能仕様書

## 概要

内線規程 JEAC 8001 および電技解釈に準拠した、低圧幹線のケーブルサイズ・MCCB定格を自動選定するブラウザベースの計算ツール。単一HTMLファイルで動作し、サーバー不要。

最大の特徴は「親幹線の自動生成」で、同一幹線名称の子回路が2件以上登録されると、受変電盤の主幹ブレーカに相当する親幹線を自動的に計算・表示する。

---

## 1. 構成と動作環境

| 項目 | 内容 |
|------|------|
| ファイル形式 | 単一HTMLファイル（HTML + インラインCSS + JSX） |
| 依存ライブラリ | React 18.2.0 / ReactDOM 18.2.0 / Babel Standalone 7.23.9（すべてCDN経由） |
| 動作環境 | モダンブラウザ（Chrome / Edge / Firefox / Safari） |
| サーバー | 不要。ローカルファイルとして開くだけで動作 |
| データ保存 | JSON形式でのImport/Exportによる外部ファイル保存 |

---

## 2. 画面構成

画面は左右2ペインの固定レイアウトで構成される。

| 領域 | 幅 | 内容 |
|------|----|------|
| ヘッダー | 全幅 | ツール名称、Import / Export / PDF出力ボタン |
| 左ペイン | 460px固定 | 入力フォーム（子回路モード / 親幹線モードを切替） |
| 右ペイン上部 | 残り幅 | 選定結果パネル（リアルタイム表示） |
| 右ペイン下部 | 残り幅 | 登録一覧テーブル（親子ツリー表示） |

左右ともペイン内で独立スクロールする（画面高さ - ヘッダー分）。

---

## 3. 入力項目一覧（子回路）

### 3-1. 回路情報

| # | 項目 | 型 | 初期値 | 選択肢・範囲 |
|---|------|-----|--------|-------------|
| 1 | 幹線番号/名称 | テキスト | 空 | 登録時必須。同一名称で子回路をグルーピング |
| 2 | 負荷名称 | テキスト | 空 | 計算書表示用。計算には不使用 |
| 3 | 電気方式 | 選択 | 三相3線式 | 単相2線式 / 単相3線式 / 三相3線式 / 三相4線式 |
| 4 | 電圧 [V] | 選択 | 200 | 電気方式に連動（後述） |
| 5 | 周波数 | 選択 | 60Hz | 50Hz / 60Hz |
| 6 | 供給方式 | 選択 | 低圧受電 | 低圧受電 / 高圧受電 |
| 7 | 回路種別 | 選択 | 一般 | 一般 / 電動機 |
| 8 | MCCB AT | 選択 | 自動 | 自動 / 標準定格から手動選択 |

### 3-2. 負荷条件

| # | 項目 | 型 | 初期値 | 範囲・ステップ |
|---|------|-----|--------|--------------|
| 9 | 負荷容量 | 数値 | 0 | 0以上。単位がAの場合は「電流」として扱う |
| 10 | 単位 | 選択 | kW | kW / kVA / A |
| 11 | 力率 cosθ | 数値 | 0.85 | 0.10〜1.00（ステップ 0.01） |
| 12 | 効率 η | 数値 | 1.0 | 0.10〜1.00。回路種別=電動機のときのみ表示 |
| 13 | 需要率 [%] | 数値 | 100 | 1〜100 |
| 14 | こう長 [m] | 数値 | 30 | 0.1以上（ステップ 0.5）。上位接続点〜分岐点の距離。分岐ブレーカー省略判定にも兼用 |

### 3-3. ケーブル条件

| # | 項目 | 型 | 初期値 | 選択肢・範囲 |
|---|------|-----|--------|-------------|
| 15 | ケーブル種類 | 選択 | CVT | CVT / CVD / CV-3C / CV-2C |
| 16 | 配線方式 | 選択 | ケーブルラック配線 | ケーブルラック / 配管 / 直埋 / 管路 |
| 17 | 周囲温度 [℃] | 数値 | 40 | 20〜50（ステップ 5） |
| 18 | 多条低減プリセット | 選択 | 1段 S=d 7列以上 | 補正なし(1.0) / 1段S=d 2列(0.85) / 1段S=d 3列(0.80) / 1段S=d 7列以上(0.70) / 2段S=d 2列(0.70) / 2段S=d 3列(0.60) / カスタム |
| 19 | 低減率（カスタム時） | 数値 | 0.70 | 0.10〜1.00。カスタム選択時のみ入力可 |

---

## 4. 入力項目一覧（親幹線）

親幹線モードでは、負荷に関する項目（容量・電流・力率等）は子回路の合計から自動算出される。ユーザーが入力するのはケーブル敷設に関する項目のみ。

| # | 項目 | 型 | 初期値 | 備考 |
|---|------|-----|--------|------|
| 1 | こう長 [m] | 数値 | 10 | 上位接続点〜分岐点。分岐ブレーカー省略判定にも兼用 |
| 1a | 分岐名称 | テキスト | 空 | 分電盤・分岐盤の名称（任意）。系統図のブスバー付近に表示 |
| 2 | 力率 cosθ | 数値 | 0.85 | 幹線としての合成力率 |
| 3 | ケーブル種類 | 選択 | CVT | CVT / CVD / CV-3C / CV-2C |
| 4 | 配線方式 | 選択 | ケーブルラック配線 | 子回路と独立して設定可能 |
| 5 | 周囲温度 [℃] | 数値 | 40 | 20〜50 |
| 6 | 多条低減 | 選択 | 1段 S=d 7列以上 | プリセットまたはカスタム |
| 7 | MCCB AT | 選択 | 自動 | 自動 / 手動指定 |

親幹線モードでは、子回路の情報が参照表示される（子回路数、合計電流、電動機/一般の内訳）。

---

## 5. 連動制御

| トリガー | 対象 | 動作 |
|---------|------|------|
| 電気方式を変更 | 電圧の選択肢 | 新方式に対応する電圧リストに切替。現在値が存在しなければ先頭値にリセット |
| 回路種別を「電動機」に | 効率ηの入力欄 | 表示する |
| 回路種別を「一般」に | 効率ηの入力欄 | 非表示にし、内部値を1.0にリセット |
| 負荷単位を「A」に | ラベル表示 | 「電流 [A]」に切替 |
| 多条低減プリセットを変更 | 低減率の値 | 対応する数値を自動セット |
| プリセット「カスタム」を選択 | 低減率入力欄 | 手動入力欄を表示 |
| 配線方式を直埋/管路に変更 | 温度補正テーブル | 基底25℃の地中テーブルに切替 |
| 配線方式をラック/配管に変更 | 温度補正テーブル | 基底40℃の気中テーブルに切替 |

### 電気方式と電圧の対応

| 電気方式 | 選択可能な電圧 [V] |
|----------|-------------------|
| 単相2線式 | 100, 200 |
| 単相3線式 | 100, 200（表示は「100/200」） |
| 三相3線式 | 200, 210, 400, 415, 440 |
| 三相4線式 | 200 |

---

## 6. 入力確定タイミング

### 即時反映（onChange）

セレクトボックス系の項目はすべて、選択と同時に計算を再実行する。

対象: 電気方式、電圧、周波数、供給方式、回路種別、負荷単位、ケーブル種類、配線方式、多条低減プリセット、MCCB AT指定

### 確定時に反映（onBlur）

数値入力は、フォーカスが外れたタイミング（またはスライダーのつまみを離したタイミング）で計算を再実行する。入力途中の中間状態では計算が走らない。

対象: 負荷容量、こう長、力率、効率、需要率、周囲温度、低減率（カスタム時）

---

## 7. 数値入力のスライダーUI

数値入力ボックスにはスライダーポップアップが付属する。

### 動作フロー

1. 入力ボックスをクリック（フォーカス取得）
2. ボックス直下にスライダーがポップアップ表示。つまみは中央位置
3. つまみをドラッグすると、現在値を起点として値が増減。入力値はリアルタイムに表示更新される（計算は未発火）
4. つまみを離すと値が確定し、計算が再実行。つまみは中央に復帰
5. ポップアップ外をクリックまたは別入力にフォーカス移動で閉じる

### スライダーの感度

| 対象項目 | ステップ | 片側の最大変動量 |
|---------|---------|----------------|
| 負荷容量 (kW/kVA) | 0.1 | ±100 |
| 負荷容量 (A) | 1 | ±200 |
| 力率 cosθ | 0.01 | ±0.30 |
| 効率 η | 0.01 | ±0.30 |
| 需要率 [%] | 1 | ±50 |
| こう長 [m] | 0.5 | ±100 |
| 周囲温度 [℃] | 5 | ±15 |
| 低減率（カスタム） | 0.01 | ±0.30 |

---

## 8. 計算ロジック

### 8-1. 設計電流の算出

負荷単位に応じて算出方法が切り替わる。

| 単位 | 三相3線式 / 三相4線式 | 単相2線式 / 単相3線式 |
|------|---------------------|---------------------|
| kW | I = P × 1000 / (√3 × V × cosθ × η) | I = P × 1000 / (V × cosθ × η) |
| kVA | I = S × 1000 / (√3 × V) | I = S × 1000 / V |
| A | 入力値をそのまま使用 | 入力値をそのまま使用 |

需要率を乗じて設計電流とする: `設計電流 = 算出電流 × 需要率[%] / 100`

### 8-2. 電動機回路の電流補正（内線規程 3705-6）

回路種別が「電動機」の場合、ケーブルサイジング用の電流を算出する。

| 条件 | サイジング電流 |
|------|--------------|
| 設計電流 ≦ 50A | 設計電流 × 1.25 |
| 設計電流 > 50A | 設計電流 × 1.1 |

### 8-3. ケーブルサイズの自動選定

以下の順で、3条件をすべて満たす最小のケーブル断面積を選定する。

```
Step 1: 許容電流による仮選定
  実効許容電流 = 基本許容電流 × 温度補正係数 × 多条低減率
  → 実効許容電流 ≧ サイジング電流 を満たす最小サイズを選択

Step 2: 電圧降下の確認
  e = K × I × (L / 1000) × Z  [V]
  Z = R × cosθ + X × sinθ     [Ω/km]
  電圧降下率 = e / 基準電圧 × 100  [%]
  → 許容値以内か判定。NGならサイズを1ランクアップしてStep 1に戻る

Step 3: 保護協調の確認
  一般回路:   実効許容電流 ≧ MCCB AT
  電動機回路: 実効許容電流 ≧ MCCB AT / 2.5
  → 不適合ならケーブルサイズアップ
```

全サイズで条件を満たせない場合は、最大サイズ（325mm²）を選定し、NG表示とする。

### 8-4. 電圧降下計算の係数

| 電気方式 | K値 | 基準電圧 |
|---------|-----|---------|
| 単相2線式 | 2 | 線間電圧（100V/200V） |
| 単相3線式 | 1 | 対地電圧 100V |
| 三相3線式 | √3 (≈ 1.732) | 線間電圧 |
| 三相4線式 | 1 | 対地電圧 |

単相3線式ではK=1、基準電圧=100Vで計算する（大地間電圧基準）。

### 8-5. 許容電圧降下

こう長と供給方式から許容電圧降下率が決まる。

| こう長 | 高圧受電 | 低圧受電 |
|-------|---------|---------|
| 60m以下 | 3% | 2% |
| 60m超〜120m | 5% | 4% |
| 120m超〜200m | 6% | 5% |
| 200m超 | 7% | 6% |

### 8-6. MCCB定格の自動選定

「自動」選択時、設計電流以上の最小標準定格を選定する。

| 回路種別 | 選定基準 |
|---------|---------|
| 一般 | 設計電流以上の最小AT |
| 電動機 | 設計電流 × 1.25 以上の最小AT |

MCCB標準定格: 15, 20, 25, 30, 32, 40, 50, 60, 63, 75, 100, 125, 150, 175, 200, 225, 250, 300, 350, 400, 500, 600, 630, 700, 800 [AT]

### 8-7. 温度補正係数

基底温度からのずれに応じて許容電流を補正する。テーブル外の中間温度は線形補間で算出する。

**気中布設（ケーブルラック・配管） — 基底 40℃:**

| 温度 [℃] | 20 | 25 | 30 | 35 | 40 | 45 | 50 |
|----------|-----|-----|-----|-----|-----|-----|-----|
| 係数 | 1.18 | 1.14 | 1.10 | 1.05 | 1.00 | 0.95 | 0.89 |

**地中布設（直埋・管路） — 基底 25℃:**

| 温度 [℃] | 20 | 25 | 30 | 35 | 40 | 45 | 50 |
|----------|-----|-----|-----|-----|-----|-----|-----|
| 係数 | 1.04 | 1.00 | 0.96 | 0.92 | 0.88 | 0.83 | 0.78 |

---

## 9. 親幹線の自動生成

### 9-1. 生成条件

同一の「幹線番号/名称」で子回路が **2件以上** 登録されると、自動的に親幹線（主幹ブレーカ相当）が生成される。1件のみの幹線名には親幹線は生成されない。

### 9-2. 親幹線の位置づけ

```
受変電盤 主幹ブレーカ (=親幹線)
  ├── 分岐回路1 (=子回路)
  ├── 分岐回路2 (=子回路)
  └── 分岐回路3 (=子回路)
```

分岐点は同一（受変電盤二次側）と想定する。親幹線の電気方式・電圧・周波数・供給方式は、最初に登録された子回路の設定を継承する。

### 9-3. 親幹線の電流算出

子回路の設計電流を回路種別ごとに集計し、電動機の有無で計算が分岐する。

```
ΣIM = 電動機回路の設計電流の合計
ΣIH = 一般回路の設計電流の合計
合計電流 = ΣIM + ΣIH
```

**電動機が1回路でも含まれる場合（電動機混在）:**

| 条件 | サイジング電流 |
|------|--------------|
| ΣIM ≦ 50A | ΣIM × 1.25 + ΣIH |
| ΣIM > 50A | ΣIM × 1.1 + ΣIH |

**電動機が含まれない場合:**

サイジング電流 = 合計電流（補正なし）

### 9-4. 親幹線のMCCB選定

| 条件 | 選定基準 |
|------|---------|
| 電動機混在 | 合計電流 × 1.25 以上の最小AT |
| 電動機なし | 合計電流以上の最小AT |

### 9-5. 親幹線の保護協調

| 条件 | 合格基準 |
|------|---------|
| 電動機混在 | 実効許容電流 ≧ MCCB AT / 2.5 |
| 電動機なし | 実効許容電流 ≧ MCCB AT |

不適合の場合はケーブルサイズを自動でアップサイズする。

### 9-6. 親幹線の編集

登録一覧の `[主幹]` 行をクリックすると、左ペインが親幹線編集モードに切り替わる。子回路の負荷情報は自動集計のため編集不可。ユーザーが編集できるのはケーブル敷設条件（こう長、力率、ケーブル種類、配線方式、温度、低減率、MCCB AT）のみ。

「親幹線を保存」ボタンで設定を確定し、子回路編集モードに戻る。

---

## 10. 内蔵データテーブル

### 10-1. インピーダンステーブル

日本電線工業会 技資第103号Aに基づく、導体温度90℃の値 [Ω/km]。ケーブル種類と周波数の組み合わせで4パターンを保持する。

**CVケーブル（CV-2C, CV-3C）用:** 2〜325mm² の13サイズ、50Hz/60Hzの各 [R, X]

**CVT/CVDケーブル用:** 8〜325mm² の10サイズ、50Hz/60Hzの各 [R, X]

CVT/CVDは導体間隔が広いためリアクタンスXがCV多心より大きい。60Hzのリアクタンスは50Hzの約1.2倍。

### 10-2. 許容電流テーブル

JCS 0168-2:2016に基づく、周囲温度40℃（気中）/ 25℃（地中）の基本許容電流 [A]。4つの配線方式それぞれについて、4種のケーブル（CVT / CVD / CV-3C / CV-2C）の許容電流を保持する。

| 配線方式 | テーブル名 | 基底温度 |
|---------|----------|---------|
| ケーブルラック配線 | 気中暗渠（コロガシ/ラック） | 40℃ |
| 配管配線 | 電線管布設 | 40℃ |
| 直埋布設 | 直接埋設 | 25℃ |
| 管路布設 | 管路引入れ | 25℃ |

許容電流の大小関係: ケーブルラック > 直埋 > 配管 ≧ 管路

### 10-3. 対応ケーブルサイズ

| ケーブル種類 | 対応断面積 [mm²] |
|------------|-----------------|
| CV-2C, CV-3C | 2, 3.5, 5.5, 8, 14, 22, 38, 60, 100, 150, 200, 250, 325 |
| CVT, CVD | 8, 14, 22, 38, 60, 100, 150, 200, 250, 325 |

---

## 11. 選定結果の表示

### 11-1. 合否判定バッジ

3つの判定項目それぞれに○/×のバッジを表示し、全条件の総合判定を表示する。

| 判定項目 | 合格条件（一般） | 合格条件（電動機） |
|---------|---------------|-----------------|
| 許容電流 | 実効許容電流 ≧ サイジング電流 | 同左 |
| 電圧降下 | 電圧降下率 ≦ 許容値 | 同左 |
| 保護協調 | 実効許容電流 ≧ MCCB AT | 実効許容電流 ≧ MCCB AT / 2.5 |

### 11-2. 表示項目

**主要結果（3項目、強調表示）:**

選定ケーブル（種類+断面積）、MCCB定格 [AT]、設計電流 [A]（親幹線の場合は「合計電流」）

**許容電流の詳細（4項目）:**

基本許容電流 [A]、温度補正係数、低減率、実効許容電流 [A]

**電圧降下の詳細（4項目）:**

合成インピーダンスZ [Ω/km]、方式係数K、電圧降下 [V] (%)、許容値 [V] (%)

**電動機回路の補足情報:**

電動機混在時はサイジング電流の内訳（電動機/一般の分離と補正率）および保護協調の閾値（AT/2.5）を補足表示する。

---

## 12. 登録一覧と親子ツリー表示

### 12-1. 表示構造

登録されたレコードは幹線番号/名称でグルーピングし、以下のツリー構造で表示する。

```
[主幹] L-101          三相3線式  200V  120A  CVT 60   200  3.2V(1.6%)  OK
  └ 電灯No.1          三相3線式  200V   40A  CVT 14    63  1.1V(0.5%)  OK
  └ 動力No.1          三相3線式  200V   80A  CVT 38   100  2.0V(1.0%)  OK
LG-102                 単相2線式  200V   25A  CV-2C 5.5  30  2.5V(1.3%)  OK
```

同一幹線名が1件のみの場合は、幹線名をそのまま表示（親幹線行なし）。2件以上になると `[主幹]` 行が自動的に先頭に挿入される。

### 12-2. テーブルカラム

| カラム | 内容 |
|--------|------|
| （種別） | `[主幹]` または `└`（子回路のインデント） |
| 幹線/負荷名 | 親=幹線名、子=負荷名称（親子構造時） |
| 方式 | 電気方式 |
| 電圧 | 電圧 [V] |
| 設計I | 設計電流 [A] |
| ケーブル | 選定結果（種類+断面積） |
| AT | MCCB定格電流 [AT] |
| e [V] | 電圧降下 [V] (%) |
| 判定 | OK / NG |
| 削除 | x ボタン（子回路のみ） |

### 12-3. 行クリック操作

| クリック対象 | 動作 |
|-------------|------|
| `[主幹]` 行 | 左ペインが親幹線編集モードに切替。結果パネルに親幹線の選定結果を表示 |
| 子回路行 | 左ペインに該当レコードの入力値を復元し、編集モードに切替 |
| x ボタン | 該当子回路を削除（クリックイベントは行クリックに伝播しない） |

---

## 13. 登録・更新・削除

### 登録

「+ 登録」ボタンを押すと、現在の入力値と計算結果をレコードとして保存する。

前提条件:
- 幹線番号/名称が空でないこと
- 負荷容量 > 0 かつ こう長 > 0 であること（計算結果が存在すること）

同一幹線名で2件目が登録された時点で、親幹線の設定データが初期値で自動生成される。

### 更新

一覧から子回路行をクリックすると、入力フォームにその値が復元される。ボタンが「更新」に変わり、押すと既存レコードを上書きする。「取消」で新規入力モードに戻る。

### 削除

各子回路行の右端にある x ボタンで削除する。削除により同一幹線名のレコードが1件以下になると、親幹線行は自動的に消える。

---

## 14. Import / Export

### Export

ヘッダーの「Export」ボタンで、全登録データと親幹線設定をJSON形式でダウンロードする。

ファイル名: `幹線計算_YYYY-MM-DD.json`

データ構造:
```json
{
  "records": [
    {
      "id": "タイムスタンプ文字列",
      "params": { "入力パラメータ一式" },
      "result": { "計算結果一式" },
      "ts": "ISO 8601 タイムスタンプ"
    }
  ],
  "parentCfgs": {
    "幹線名": {
      "cableLength": 10,
      "cableType": "CVT",
      "wiringMethod": "ケーブルラック配線",
      "ambientTemp": 40,
      "reductionPreset": "1段 S=d 7列以上",
      "reductionFactor": 0.70,
      "mccbATOverride": "自動",
      "powerFactor": 0.85
    }
  }
}
```

### Import

ヘッダーの「Import」ボタンでJSONファイルを読み込み、既存データに追記する。`records` と `parentCfgs` の両方を復元する。旧形式（配列のみ）との後方互換性あり。

---

## 15. PDF出力

ヘッダーの「PDF出力」ボタンで、公共建築工事標準仕様書 様式 電-8-1 に準じた電路計算書をHTML形式で新規ウィンドウに表示し、ブラウザの印刷ダイアログを起動する。

### 用紙設定

A3横向き、余白8mm

### 出力項目

ヘッダー行: 幹線番号/名称、電気方式、電圧[V]、遮断器[AT]、負荷名称、負荷容量[kW]、設計電流[A]、L[m]、許容電流（種別/太さ、配線、許容[A]、低減率、補正後[A]）、電圧降下（K、cosθ、Z、e[V]、許容e[V]）

親幹線行は太字・背景色付きで区別表示される。子回路行はインデントして表示する。

フッターに計算式の注記を記載:
- e = KIlZ/1000 [V] の定義
- K値の一覧
- 保護協調の判定基準

---

## 16. 準拠規格

| 規格・法規 | 適用範囲 |
|-----------|---------|
| 内線規程 JEAC 8001 | 許容電圧降下（1310節）、電動機回路の幹線太さ基準（3705節） |
| 電技解釈 第148条 | 低圧幹線の施設（許容電流、MCCB定格、保護協調） |
| JCS 0168-1/2:2016 | ケーブル許容電流計算の式と定数、低圧ケーブル許容電流表 |
| 日本電線工業会 技資第103号A | CVケーブルのインピーダンス表（導体温度90℃） |
| JIS C 3605 / C 3606 | 600V CVケーブル / CVTケーブルの規格 |
| JIS C 8201-2-1 | 配線用遮断器（MCCB）の規格 |

---

## 17. 技術的な実装仕様

### 状態管理（P3 までの単一回路）

入力値は2層で管理する。`live`（表示用・リアルタイム追従）と `calc`（計算用・確定値のみ）を分離し、数値入力中の不要な再計算を防止している。セレクトボックスは両方を即座に更新し、数値入力はフォーカスアウト時にのみ `calc` を更新する。

### 計算の再実行タイミング

`calc` の値が変更されるたびに `useMemo` で計算が再実行される。親幹線の計算結果も `useMemo` で子回路のレコード変更や親設定の変更に追従する。

### ライブラリ

- React 18.2.0 — UI描画
- ReactDOM 18.2.0 — DOMレンダリング
- Babel Standalone 7.23.9 — ブラウザ内でのJSXトランスパイル

すべて cdnjs.cloudflare.com からCDN読み込み。ビルド工程は不要。

---

## 18. 配電系統ツリーモデル

### 18-1. 概要

P4 で導入する配電系統のツリーデータモデル。変圧器から末端負荷回路までの配電経路を 4 階層のツリー構造で表現する。各ノードは `parentId` で親子関係を持ち、ボトムアップの電流集計とトップダウンの電圧降下累積を再帰的に行う。

### 18-2. ノードタイプ

| タイプ | 用途 | 配置可能レベル |
|--------|------|---------------|
| `transformer` | 変圧器（電圧変換点） | Level 0（ルート） |
| `trunk` | 幹線ケーブル（主幹・副幹） | Level 1〜2 |
| `load` | 負荷回路（末端分岐） | 最深レベル（trunk の直接の子） |

### 18-3. 4 階層の制約

```
Level 0: transformer (ルート)
Level 1: trunk (主幹)
Level 2: trunk (副幹) ※ 任意
Level 3: load (負荷回路)
```

- `depth ≦ 3`（ルート = 0 起算）
- transformer は Level 0 のみ配置可能
- trunk は Level 1〜2 に配置可能
- load は trunk の直接の子としてのみ配置可能
- transformer を持たない trunk もルートノードとして許容する（後方互換）

### 18-4. 再帰的接続の概念

任意の trunk ノードの末端（配下の load 群）を、別の transformer 配下の主幹として参照可能とする設計思想。P4 ではデータモデルに `externalRef` 予約フィールドを用意し、将来の Milestone 2（幹線系統図自動生成）との統合に備える。

### 18-5. ノードスキーマ

全ノード共通:

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `id` | string | 一意識別子（`crypto.randomUUID()` or fallback） |
| `type` | string | `'transformer'` / `'trunk'` / `'load'` |
| `parentId` | string \| null | 親ノード ID。null = ルートノード |
| `order` | number | 兄弟間の表示順序 |
| `ts` | string | ISO 8601 作成/更新タイムスタンプ |

タイプ別データフィールド:

- **transformer**: `transformer` オブジェクト（§19 参照）
- **trunk**: `trunk` オブジェクト（ケーブル敷設条件 + 継承された電気方式パラメータ）
- **load**: `load` オブジェクト（§3 の子回路パラメータ全量）

### 18-6. ツリー操作

| 操作 | 説明 |
|------|------|
| `addNode(nodes, node)` | ノード追加。depth 制約を検証 |
| `updateNode(nodes, id, patch)` | ノード更新。タイプ変更不可 |
| `removeNode(nodes, id)` | ノード削除。子孫も再帰的に削除 |
| `getChildren(nodes, parentId)` | 直接の子ノード一覧（order 順） |
| `getDepth(nodes, id)` | ルートからの深さ（0 起算） |
| `buildTree(nodes)` | 表示用ツリー構造を構築 |

### 18-7. 状態管理（P4 以降）

```javascript
const [nodes, setNodes] = useState([]);           // 全ノード配列
const [selectedId, setSelectedId] = useState(null); // 選択中ノード ID
const [editMode, setEditMode] = useState('load');   // 'load' | 'trunk' | 'transformer'
```

既存の `params` / `display` の 2 層管理はそのまま残し、選択ノードのタイプに応じて左ペインのフォームを切り替える。

---

## 19. 変圧器ノード

### 19-1. 入力項目

| # | 項目 | 型 | 初期値 | 選択肢・範囲 |
|---|------|-----|--------|-------------|
| 1 | 変圧器名称 | テキスト | TR-1 | 任意 |
| 2 | 変圧器種別 | 選択 | 三相油入 | 三相油入 / 単相油入 / モールド |
| 3 | 容量 [kVA] | 選択/数値 | 500 | 種別に応じた標準容量（§19-2参照）or カスタム |
| 4 | 一次電圧 [V] | 選択 | 6600 | 3300 / 6600 |
| 5 | 二次電圧 [V] | 選択 | 210 | 105 / 210 / 420 |
| 6 | %Z（パーセントインピーダンス） | 数値 | 自動 | 容量に連動した典型値 or カスタム入力 |
| 7 | X/R 比 | 数値 | 自動 | 容量に連動した値 or カスタム入力（油入のみ。モールドは手動入力） |
| 8 | 結線方式 | 選択 | Δ-Y | Δ-Y / Y-Y / Δ-Δ / Y-Δ / V-V |

- 種別変更時、容量の選択肢リストと %Z / X/R比 の自動値が切り替わる
- モールド変圧器はメーカーカタログが %Z 範囲（min〜max）を提示するため、短絡電流計算には min 値（最大電流側）、電圧降下計算には max 値を使用する

### 19-2. 容量と %Z / X/R 比の対応

#### 19-2a. 三相油入変圧器（6.6kV/210V）

河村電器産業カタログ（メーカー数社平均値）に基づく。国内の短絡電流計算で最も広く参照されるデータセット:

| 容量 [kVA] | %Z | X/R比 | %R | %X |
|---:|---:|---:|---:|---:|
| 50 | 2.23 | 0.73 | 1.80 | 1.31 |
| 75 | 2.42 | 1.05 | 1.67 | 1.75 |
| 100 | 2.50 | 1.11 | 1.67 | 1.86 |
| 150 | 2.56 | 1.29 | 1.57 | 2.02 |
| 200 | 3.08 | 1.64 | 1.60 | 2.63 |
| 300 | 3.22 | 1.91 | 1.49 | 2.85 |
| 500 | 4.00 | 2.98 | 1.27 | 3.79 |
| 750 | 5.09 | 3.76 | 1.31 | 4.92 |
| 1000 | 5.08 | 4.22 | 1.17 | 4.94 |
| 1500 | 5.55 | 4.40 | 1.23 | 5.41 |
| 2000 | 6.00 | 5.21 | 1.13 | 5.89 |

%R と %X は %Z と X/R比 から次式で算出: `%R = %Z / √(1 + (X/R)²)`, `%X = (X/R) × %R`

#### 19-2b. 単相三線式油入変圧器（6.6kV/210-105V）

| 容量 [kVA] | %Z | X/R比 |
|---:|---:|---:|
| 10 | 2.71 | 0.87 |
| 20 | 2.49 | 1.02 |
| 30 | 2.65 | 1.37 |
| 50 | 2.69 | 1.56 |
| 75 | 2.54 | 1.32 |
| 100 | 2.91 | 1.59 |
| 150 | 2.82 | 1.73 |
| 200 | 3.10 | 2.07 |
| 300 | 3.90 | 2.91 |
| 500 | 4.30 | 3.67 |

#### 19-2c. モールド変圧器（三相50Hz）

三菱電機Rシリーズ。製造ばらつきの保証範囲。短絡電流計算では最小値（最大電流側）、電圧降下計算では最大値を使用:

| 容量 [kVA] | %Z 下限 | %Z 上限 |
|---:|---:|---:|
| 50 | 3.1 | 5.9 |
| 75 | 2.6 | 5.0 |
| 100 | 3.2 | 6.2 |
| 150 | 2.4 | 5.2 |
| 200 | 2.5 | 5.4 |
| 300 | 3.1 | 6.5 |
| 500 | 2.9 | 7.6 |
| 750 | 3.8 | 7.3 |
| 1000 | 3.6 | 7.7 |
| 1500 | 3.6 | 7.5 |
| 2000 | 3.7 | 7.7 |

容量選択時に %Z / X/R比 が「自動」であれば対応する値を自動セットする。カスタム入力で上書き可能。

### 19-3. 計算ロジック

```
%Z → R+jX 分解（X/R比が利用可能な場合）:
  %R = %Z / √(1 + (X/R)²)
  %X = %R × (X/R)

ソースインピーダンス [Ω]（R+jX 分解）:
  S  = kVA × 1000 [VA]
  Rs = (%R / 100) × Vs² / S
  Xs = (%X / 100) × Vs² / S
  |Zs| = √(Rs² + Xs²)

※ X/R比 が未提供（モールド変圧器等）の場合:
  |Zs| = (%Z / 100) × Vs² / S
  Rs = |Zs|, Xs = 0 （保守側: 全て抵抗分として扱う → 最大 Isc₃）

定格二次電流 [A]（三相）:
  In = (kVA × 1000) / (√3 × Vs)

三相短絡電流 [A]:
  Isc₃ = Vs / (√3 × |Zs|)
       = In / (%Z / 100)

変圧器利用率 [%]:
  U = (子ノード合計負荷 [kVA]) / 容量 [kVA] × 100
```

ここで Vs は二次電圧 [V]。Rs, Xs は §20 の短絡電流 R+jX ベクトル累積計算で使用する。

### 19-4. 電圧継承

変圧器の `secondaryVoltage` は下位の全 trunk / load ノードの `voltage` として自動継承される。

- trunk ノードの `system`, `freq`, `supplyType` は最初の子 load ノード登録時に決定
- 変圧器の二次電圧変更時、配下の全ノードの `voltage` を一括更新する
- `supplyType` は変圧器が存在する場合「高圧受電」に自動設定

### 19-5. HV 側パラメータ（将来用予約）

transformer ノードには HV 側のパラメータフィールドを予約する:

| フィールド | 型 | 用途 |
|-----------|-----|------|
| `hvSystem.cableType` | string \| null | 高圧ケーブル種別（CV-3C / CVT） |
| `hvSystem.cableSize_mm2` | number \| null | 高圧ケーブル導体サイズ [mm²] |
| `hvSystem.totalCableLength_km` | number \| null | 高圧ケーブル総こう長 [km] |
| `hvSystem.capacitance_uF_per_km` | number \| null | 対地静電容量 [μF/km] |

- 高圧ケーブルインピーダンスは `IMP_HV` テーブル（`data/impedance-hv.json`）から取得
- HV ケーブルインピーダンスの LV 側換算: `Z_hv_lv = Z_hv × (Vs/Vp)²`
- 対地静電容量は M2-3（一線地絡電流計算: Ig = 3ωCV）で使用
- P4 では全て null のまま

---

## 20. 短絡・地絡電流計算

### 20-1. 概要

変圧器ノードの %Z を起点として、配電系統ツリーの各ノードにおける利用可能短絡電流を算出する。ケーブルインピーダンスの累積により、下流ノードほど短絡電流が減衰する。

### 20-2. LV 側短絡電流（R+jX ベクトル累積）

短絡電流計算では R+jX ベクトル累積方式を使用する。電圧降下計算のスカラー方式（`Z = R·cosθ + X·sinθ`、負荷力率角で投影）とは異なり、短絡時のインピーダンスは回路自身の R, X で決まるため、R 成分と X 成分を独立に累積して合成する。

```
変圧器二次側（§19-3 で算出した Rs, Xs を使用）:
  ※ HV ケーブルがある場合（§19-5 のフィールドが非 null）:
    Rhv = R_hv [Ω/km] × L_hv [km]
    Xhv = X_hv [Ω/km] × L_hv [km]
    Rhv_lv = Rhv × (Vs/Vp)²
    Xhv_lv = Xhv × (Vs/Vp)²
    Rsrc = Rs + Rhv_lv
    Xsrc = Xs + Xhv_lv
  ※ HV ケーブルなしの場合:
    Rsrc = Rs
    Xsrc = Xs
  |Zsrc| = √(Rsrc² + Xsrc²)
  Isc₃ = Vs / (√3 × |Zsrc|)

ケーブル区間を経た下流点:
  ケーブルの R, X を IMP_CV / IMP_CVT テーブルから取得
  Rc = R [Ω/km] × L [km]
  Xc = X [Ω/km] × L [km]

  Rtotal = Rsrc + ΣRc_i  （上流からの R 累積）
  Xtotal = Xsrc + ΣXc_i  （上流からの X 累積）
  |Ztotal| = √(Rtotal² + Xtotal²)
  Isc₃ = Vs / (√3 × |Ztotal|)
```

ここで:
- R, X [Ω/km] はケーブルインピーダンステーブル（IMP_CV / IMP_CVT）の [R, X] ペア
- L [km] はケーブルこう長 [m] / 1000
- 電圧降下計算で使用するスカラー式 `Z = R·cosθ + X·sinθ` は短絡電流計算には使用しない（負荷力率角に依存するため不適切）

### 20-3. トップダウン累積

計算はツリーのルート（変圧器）からリーフ（負荷回路）に向かって行う:

1. 変圧器: Zs を算出
2. Level 1 trunk: Ztotal = Zs + Z₁×L₁
3. Level 2 trunk: Ztotal = Zs + Z₁×L₁ + Z₂×L₂
4. load: Ztotal = Zs + Z₁×L₁ + Z₂×L₂ + Z₃×L₃

各ノードの Isc₃ = Vs / (√3 × Ztotal) を結果に格納する。

### 20-4. 表示

- 各ノードの結果パネルに「利用可能短絡電流 Isc₃ [kA]」を表示
- MCCB の遮断容量との簡易照合（§20-4a）
- ツリーテーブルにオプション列として Isc₃ を表示可能
- 短絡電流プロファイルカーブ（§20-4b）

#### 20-4a. 遮断容量チェック（簡易照合）

MCCB 選定時にフレーム/遮断容量クラス（経済型 / 高遮断型等）を選択し、Icu を自動決定する。

```
検証条件:
  Icu ≥ Isc₃

表示:
  結果パネル「短絡電流」セクション内に
  「遮断容量 Icu [kA] ≥ Isc₃ [kA]」行を追加し、OK/NG バッジ表示
```

データ: `data/mccb-icu.json`（新規）にフレーム別・電圧別・クラス別の遮断容量テーブルを整備。出典は JIS C 8201-2-1 および主要メーカーカタログ。

#### 20-4b. 短絡電流プロファイルカーブ

右ペインの新タブ `[プロファイル]` として、変圧器から末端負荷回路への経路に沿った短絡電流の減衰曲線と各種保護しきい値を重ね描きする SVG チャートを表示する。

```
構成要素:
  主曲線:    Isc₃ 減衰（各ノードの利用可能短絡電流を折れ線で接続）
  しきい値線: Icu（遮断容量）、Iw（ケーブル熱耐量）、Ig(LV)（地絡電流）、IΔn（ELCB 感度）
  X 軸:     ツリー上の経路位置（等間隔、ノード名ラベル）
  Y 軸:     電流 [kA]（対数スケール基本、線形切替可能）

経路選択:
  - TreeTable 行クリック時、そのノードからルートまでの経路を自動選択
  - ◀ ▶ で同一変圧器配下の末端ノード間を巡回
  - ノード点クリック → 左ペインにそのノードの編集フォーム展開

レイヤー表示:
  チェックボックスで Icu / Iw / Ig / IΔn の表示切替
  デフォルト ON: Icu, Iw

交差点の強調:
  Isc₃ がしきい値を上回る = 保護機器能力不足 → 赤マーク + ツールチップ
  Isc₃ がしきい値を下回る = 安全確認 → 控えめな緑ドット
```

設計思想の詳細は `docs/ux-protection-design.md` を参照。

### 20-5. HV 側一線地絡電流

非接地系 6.6kV 系統における一線地絡電流:

```
Ig = 3ωCV
   = 3 × 2πf × C × (V / √3)
```

ここで:
- f: 系統周波数 [Hz]
- C: 系統全体の一相あたり対地静電容量 [F]
- V: 系統の線間電圧 [V]

P4 ではデータモデル準備のみ（§19-5）。M2-2 で HV 系統モデリング、M2-3 で計算実装。

#### 20-5a. B種接地抵抗の表示

TransformerResultPanel に「接地設計」セクションを追加し、Ig と B種接地抵抗上限 Rb を表示する。

```
B種接地抵抗上限:
  VCB 0.5秒以内遮断の場合:  Rb ≤ 150 / Ig  [Ω]
  VCB 1.0秒以内遮断の場合:  Rb ≤ 600 / Ig  [Ω]
```

入力: 変圧器フォーム hvSystem セクションのケーブル静電容量パラメータ、または系統対地静電容量の直接入力。

### 20-6. 短時間耐電流検証（ケーブル熱耐量チェック）

各ノードの短絡電流 Isc₃ に対して、選定されたケーブルが短絡時間中に耐えられるかを検証する。JCS 0168-1:2016 に基づく断熱条件（2秒以下）の簡略計算式:

```
短絡時許容電流:
  I_withstand = K × A / √t

I²t 許容値:
  I²t_cable = (K × A)²

検証条件:
  Isc₃² × t ≤ (K × A)²
  ⟺ Isc₃ ≤ K × A / √t
```

ここで:
- K: 導体材質・絶縁体種別による定数（WITHSTAND テーブル参照）
  - 銅導体/XLPE（CV, CVT）: K = 134（JCS規格、T₂ = 230°C）
  - 銅導体/PVC（VV）: K = 97
- A: 導体断面積 [mm²]
- t: 短絡継続時間 [s]（MCCB 遮断時間。デフォルト 0.1s、ユーザー変更可能）

表示:
- 各ノードの結果パネルに「熱耐量 OK/NG」バッジを表示
- NG の場合、必要最小ケーブルサイズを表示

### 20-7. 地絡電流計算（将来実装・M2-3）

対称座標法に基づく一線地絡電流計算。零相インピーダンスは Z_ZERO テーブルの推定係数と変圧器結線方式別乗数から算出:

```
一線地絡電流:
  Ig = 3 × Ea / (2×Z₁ + Z₀ + 3×Zf)

ここで:
  Ea = Vs / √3（相電圧）
  Z₁ = 正相インピーダンス（= §20-2 の |Ztotal|）
  Z₂ = 逆相インピーダンス（静的機器では Z₁ = Z₂）
  Z₀ = 零相インピーダンス（ケーブル零相比 × Z₁ + 変圧器結線乗数 × Z_T）
  Zf = 地絡点接触抵抗（ボルト地絡: Zf = 0）
```

### 20-8. ELCB 保護協調（将来実装・M2-3）

TT 系統の地絡保護条件: `RA × IΔn ≤ 50V`

ELCB の感度電流・動作時間と接地抵抗の組み合わせにより保護協調を判定。ELCB テーブル参照。

---

## 21. 幹線グループ管理（M2-6）

### 21-1. 概要

複数の変圧器系統を「幹線グループ」として論理的にグルーピングし、キャンバス上でグループ単位の配置・折りたたみ/展開表示を可能にする。グループ間の任意接続（クロスリンク）を定義でき、TreeTable および系統図上で接続関係を可視化する。

### 21-2. グループデータモデル

```javascript
// App ステート
const [groups, setGroups] = useState([]);
const [crossLinks, setCrossLinks] = useState([]);

// Group スキーマ
{
  id: string,                    // 一意識別子
  name: string,                  // 表示名（例: "動力盤-1"）
  color: string,                 // アクセントカラー
  rootNodeId: string,            // ルートノード ID（通常は transformer）
  canvas: { x, y, collapsed }   // キャンバス配置情報
}

// CrossLink スキーマ
{
  id: string,
  fromGroupId: string,           // 送り側グループ
  toGroupId: string,             // 受け側グループ
  fromNodeId: string | null,     // 具体的ノード（null = グループ全体）
  toNodeId: string | null,
  linkType: string,              // 'tie' | 'emergency' | 'backup' | 'custom'
  label: string,                 // 表示ラベル
  lineStyle: string,             // 'dashed' | 'dotted' | 'solid'
  color: string                  // 線の色
}
```

### 21-3. グループ所属の導出

ノード側に `groupId` を持たない。グループの `rootNodeId` からツリー走査で所属ノードを導出する。

```
getGroupNodes(nodes, rootNodeId) → [rootNode, ...descendants]
findGroupForNode(groups, nodes, nodeId) → group | null
```

### 21-4. 自動グループ化

- 変圧器ノード追加時に自動でグループを作成
- Import 時に旧形式（M2）からのデータにはグループを自動補完
- 「全自動グループ化」ボタンで未分類ルートノードに一括グループ割当

### 21-5. キャンバス表示

| モード | 表示 |
|--------|------|
| 展開（`collapsed: false`） | 所属ノードのモジュールを通常表示。グループ枠（破線 + 半透明背景）で囲む |
| 折りたたみ（`collapsed: true`） | サマリーボックス（グループ名、変圧器情報、回路数、総合判定） |

クロスリンクはグループ重心間のベジェ曲線で描画。線種・色はリンク定義に従う。

### 21-6. TreeTable 統合

- グループヘッダ行（名前 + アクセントカラー + 回路数 + 総合判定）
- 折りたたみ/展開ボタン
- クロスリンクインジケータ（「← TR1 から連絡給電」等）
- 未分類ルートノードは「未分類」セクションに表示

### 21-7. グループ単位出力

PDF 出力・系統図出力ボタンにドロップダウンメニューを追加:
- 「全体（結合出力）」: 全ノードを含む出力（従来動作）
- グループ個別選択: そのグループの所属ノードのみ出力

### 21-8. Export/Import

- Export バージョン: `'M2G'`
- エクスポートデータ: `{ version, nodes, groups, crossLinks, systemMeta, exportedAt }`
- M2 形式からのインポート時: `groups` を自動生成、`crossLinks` は空配列

### 21-9. 計算エンジンへの影響

**ゼロ**。`calculateAll()`, `runCalc()`, `runParentCalc()`, `calcFaultCurrents()` は一切変更しない。グループとクロスリンクは純粋なプレゼンテーション層。
