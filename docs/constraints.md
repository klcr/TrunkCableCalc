# 低圧幹線ケーブル計算ツール — 制約条件一覧

本ドキュメントは、コード・仕様書・データファイルに実装されている制約条件を体系的に整理したものである。

> **凡例**
> - **H**（Hard）: 違反時に計算不可・NG 判定となる必須制約
> - **S**（Soft）: 推奨値・UI 表示上の制約。違反してもエラーにはならない
> - **根拠**: 準拠する規格・法規。コード内の該当関数も併記

---

## 目次

1. [入力値の範囲制約](#1-入力値の範囲制約)
2. [電気方式・電圧の組合せ制約](#2-電気方式電圧の組合せ制約)
3. [ケーブル種類と電気方式の対応制約](#3-ケーブル種類と電気方式の対応制約)
4. [ケーブルサイズの利用可能範囲](#4-ケーブルサイズの利用可能範囲)
5. [設計電流の算出制約](#5-設計電流の算出制約)
6. [電動機回路の電流補正制約](#6-電動機回路の電流補正制約)
7. [許容電圧降下の制約](#7-許容電圧降下の制約)
8. [電圧降下計算の方式係数](#8-電圧降下計算の方式係数)
9. [温度補正の制約](#9-温度補正の制約)
10. [多条低減率の制約](#10-多条低減率の制約)
11. [MCCB 定格選定の制約](#11-mccb-定格選定の制約)
12. [ケーブルサイズ選定の 3 条件制約](#12-ケーブルサイズ選定の-3-条件制約)
13. [親幹線（幹線ノード）の制約](#13-親幹線幹線ノードの制約)
14. [分岐ブレーカー省略条件](#14-分岐ブレーカー省略条件)
15. [配電系統ツリーの構造制約](#15-配電系統ツリーの構造制約)
16. [変圧器ノードの制約](#16-変圧器ノードの制約)
17. [短絡電流計算の制約](#17-短絡電流計算の制約)
18. [短時間耐電流（熱耐量）の制約](#18-短時間耐電流熱耐量の制約)
19. [遮断容量チェックの制約](#19-遮断容量チェックの制約)
20. [地絡電流・接地の制約](#20-地絡電流接地の制約)
21. [ELCB 保護協調の制約](#21-elcb-保護協調の制約)
22. [データテーブルの構造制約](#22-データテーブルの構造制約)
23. [登録・更新・削除の制約](#23-登録更新削除の制約)
24. [Import/Export の制約](#24-importexport-の制約)
25. [UI 動作の制約](#25-ui-動作の制約)
26. [アーキテクチャ制約](#26-アーキテクチャ制約)

---

## 1. 入力値の範囲制約

コード内の入力コンポーネント（`Slider`）および HTML `<input>` 要素で強制される数値範囲。

| # | 項目 | 最小値 | 最大値 | ステップ | 初期値 | 種別 | 根拠 |
|---|------|--------|--------|----------|--------|------|------|
| 1 | 負荷容量 (kW/kVA) | 0 | — | 0.1 | 15 | H | spec §3-2 #9 |
| 2 | 負荷容量 (A) | 0 | — | 1 | 15 | H | spec §3-2 #9 |
| 3 | 力率 cosθ | 0.10 | 1.00 | 0.01 | 0.85 | H | spec §3-2 #11 |
| 4 | 効率 η | 0.10 | 1.00 | 0.01 | 1.0 | H | spec §3-2 #12 |
| 5 | 需要率 [%] | 1 | 100 | 1 | 100 | H | spec §3-2 #13 |
| 6 | こう長 [m]（子回路） | 0.1 | — | 0.5 | 30 | H | spec §3-2 #14 |
| 7 | こう長 [m]（幹線） | 0.5 | — | 0.5 | 10 | H | spec §4 #1 |
| 8 | 周囲温度 [℃] | 20 | 50 | 5 | 40 | H | spec §3-3 #17 |
| 9 | 低減率（カスタム） | 0.10 | 1.00 | 0.01 | 0.70 | H | spec §3-3 #19 |
| 10 | 変圧器 %Z | 0 | — | 0.01 | 自動 | H | spec §19-1 |
| 11 | 変圧器 X/R 比 | 0 | — | 0.01 | 自動 | H | spec §19-1 |
| 12 | HV ケーブルこう長 [km] | 0 | — | 0.01 | null | S | spec §19-5 |
| 13 | HV 対地静電容量 [μF/km] | 0 | — | 0.01 | null | S | spec §19-5 |

**スライダー感度制約**（`SLIDER_CFG`、spec §7）:

| 対象項目 | ステップ | 片側最大変動量 |
|---------|---------|--------------|
| 負荷容量 (kW/kVA) | 0.1 | ±100 |
| 負荷容量 (A) | 1 | ±200 |
| 力率 cosθ | 0.01 | ±0.30 |
| 効率 η | 0.01 | ±0.30 |
| 需要率 [%] | 1 | ±50 |
| こう長 [m] | 0.5 | ±100 |
| 周囲温度 [℃] | 5 | ±15 |
| 低減率（カスタム） | 0.01 | ±0.30 |

**コード参照**: `DEFAULT_PARAMS`（L2271）, `SLIDER_CFG`（L2258）, `Slider` コンポーネントの `clamp`（L2802）

---

## 2. 電気方式・電圧の組合せ制約

`VOLTAGE_OPTIONS`（L2243）で定義。電気方式に対して選択可能な電圧は以下に限定される。

| 電気方式 | 選択可能な電圧 [V] | 種別 |
|----------|-------------------|------|
| 単相2線式 | 100, 105, 200, 210 | H |
| 単相3線式 | 100, 105, 200, 210 | H |
| 三相3線式 | 200, 210, 400, 415, 420, 440 | H |
| 三相4線式 | 200, 210, 400, 415, 420, 440 | H |

**連動制約**:
- 電気方式を変更したとき、現在の電圧が新方式の選択肢に含まれなければ先頭値にリセット（L5245）
- 電気方式変更時、ケーブル種類の選択肢も連動更新（L5247）

**仕様書との差異**: 仕様書（spec §5）では三相4線式の電圧は 200V のみだが、コードでは三相3線式と同じ選択肢を提供している。

**根拠**: spec §5, 内線規程 JEAC 8001

---

## 3. ケーブル種類と電気方式の対応制約

`getCableTypeOptions(sys)`（L2251）で定義。

| 電気方式 | 選択可能なケーブル種類 |
|----------|---------------------|
| 単相2線式 | CV-2C |
| 単相3線式 | CV-3C |
| 三相3線式 / 三相4線式 | CVT, CVD, CV-3C |

**種別**: H — 不適切な組合せは選択肢に表示されない

---

## 4. ケーブルサイズの利用可能範囲

`SIZES_CVT`（L191）, `SIZES_CV`（L192）で定義。

| ケーブル種類 | 対応断面積 [mm²] | サイズ数 |
|------------|-----------------|---------|
| CVT, CVD | 8, 14, 22, 38, 60, 100, 150, 200, 250, 325 | 10 |
| CV-2C, CV-3C | 2, 3.5, 5.5, 8, 14, 22, 38, 60, 100, 150, 200, 250, 325 | 13 |

**上限制約**: 単線での最大サイズは **325mm²**。全サイズ不適合の場合は **325mm² × 2 条並列** を試行する（L344–376）。それでも不適合の場合は NG 判定。

**種別**: H

**根拠**: JCS 0168-2:2016, 技資第 103 号 A

**既知の制限**: 400mm², 500mm² のデータは `short-time-withstand.json` にのみ存在し、インピーダンス・許容電流テーブルには未整備（pending-issues.md Issue 3）

---

## 5. 設計電流の算出制約

`runCalc`（L276）の §8-1 で実装。

| 負荷単位 | 三相（3線式 / 4線式） | 単相（2線式 / 3線式） |
|---------|---------------------|---------------------|
| kW | `I = P × 1000 / (√3 × V × cosθ × η)` | `I = P × 1000 / (V × cosθ × η)` |
| kVA | `I = S × 1000 / (√3 × V)` | `I = S × 1000 / V` |
| A | 入力値をそのまま使用 | 入力値をそのまま使用 |

設計電流 = 算出電流 × 需要率[%] / 100

**制約**:
- `cosθ = 0` のとき除算エラー（0.10 以上の入力制約で防止）
- `η = 0` のとき除算エラー（0.10 以上の入力制約で防止）
- `V = 0` のとき除算エラー（選択肢で防止）

**種別**: H

**根拠**: spec §8-1

---

## 6. 電動機回路の電流補正制約

`runCalc`（L294–297）、`runParentCalc`（L419–421）、`runTrunkCalc`（L604–605）で実装。

### 6-1. 子回路（個別電動機）

| 条件 | サイジング電流 |
|------|--------------|
| 設計電流 ≦ 50A | 設計電流 × 1.25 |
| 設計電流 > 50A | 設計電流 × 1.1 |

### 6-2. 親幹線 / 幹線ノード（電動機混在時）

| 条件 | サイジング電流 |
|------|--------------|
| ΣIM ≦ 50A | ΣIM × 1.25 + ΣIH |
| ΣIM > 50A | ΣIM × 1.1 + ΣIH |

- ΣIM = 電動機回路の設計電流合計
- ΣIH = 一般回路の設計電流合計
- 電動機がない場合は補正なし（サイジング電流 = 合計電流）

**種別**: H

**根拠**: 内線規程 JEAC 8001 3705-6, 電技解釈第 148 条

---

## 7. 許容電圧降下の制約

`getAllowVdP(L, sup)`（L248）で実装。

| こう長 | 高圧受電 | 低圧受電 |
|-------|---------|---------|
| 60m 以下 | 3% | 2% |
| 60m 超〜120m | 5% | 4% |
| 120m 超〜200m | 6% | 5% |
| 200m 超 | 7% | 6% |

**種別**: H — 電圧降下率がこの許容値を超えるケーブルサイズは不適合

**根拠**: 内線規程 JEAC 8001 1310 節

---

## 8. 電圧降下計算の方式係数

`getVdParams(sys, V)`（L237）で実装。

| 電気方式 | K 値 | 基準電圧 |
|---------|------|---------|
| 単相2線式 | 2 | 線間電圧 V |
| 単相3線式 | 1 | 100V（対地電圧固定） |
| 三相3線式 | √3 (≈ 1.732) | 線間電圧 V |
| 三相4線式 | 1 | V / √3（対地電圧） |

**電圧降下の計算式**（精密式、常時使用）:

```
Z = R × cosθ + X × sinθ  [Ω/km]
e = K × I × (L / 1000) × Z  [V]
電圧降下率 = e / baseV × 100  [%]
```

**制約**: 簡略式へのフォールバックは設けない（CLAUDE.md 設計方針）

**種別**: H

**根拠**: spec §8-4, CLAUDE.md

---

## 9. 温度補正の制約

`getTempFactor(wm, temp)`（L222）で実装。データは `temp-correction.json` → `TC`。

### 9-1. 気中布設（ケーブルラック / 配管）— 基底 40℃

| 温度 [℃] | 20 | 25 | 30 | 35 | 40 | 45 | 50 |
|----------|-----|-----|-----|-----|-----|-----|-----|
| 係数 | 1.18 | 1.14 | 1.10 | 1.05 | 1.00 | 0.95 | 0.89 |

### 9-2. 地中布設（直埋 / 管路）— 基底 25℃

| 温度 [℃] | 20 | 25 | 30 | 35 | 40 | 45 | 50 |
|----------|-----|-----|-----|-----|-----|-----|-----|
| 係数 | 1.04 | 1.00 | 0.96 | 0.92 | 0.88 | 0.83 | 0.78 |

**補間制約**:
- テーブル内の中間温度は **線形補間** で算出（L228–232）
- テーブル外の温度: 下限（20℃）以下は 20℃ の係数、上限（50℃）以上は 50℃ の係数をそのまま使用（L226–227）

**配線方式との連動**:
- 直埋布設 / 管路布設 → `ground` テーブル
- ケーブルラック配線 / 配管配線 → `air` テーブル

**種別**: H

**根拠**: 内線規程 JEAC 8001, `data/temp-correction.json`

---

## 10. 多条低減率の制約

`data/reduction-presets.json` → `RED_PRE` で定義。

| プリセット名 | 低減率 |
|-------------|--------|
| 補正なし(1.0) | 1.00 |
| 1段 S=d 2列 | 0.85 |
| 1段 S=d 3列 | 0.80 |
| 1段 S=d 7列以上 | 0.70 |
| 2段 S=d 2列 | 0.70 |
| 2段 S=d 3列 | 0.60 |
| カスタム | ユーザー入力（0.10〜1.00） |

**種別**: H（プリセット選択時は固定値、カスタム時は範囲制約）

**根拠**: 内線規程 JEAC 8001

---

## 11. MCCB 定格選定の制約

`selectMCCB(dI, circuitType)`（L257）、`data/mccb-ratings.json` → `MCCB_AT` で実装。

### 11-1. 標準定格 [AT]

```
15, 20, 25, 30, 32, 40, 50, 60, 63, 75, 100, 125, 150, 175, 200,
225, 250, 300, 350, 400, 500, 600, 630, 700, 800
```

### 11-2. 自動選定ルール

| 回路種別 | 選定基準 | コード |
|---------|---------|--------|
| 一般 | 設計電流以上の最小 AT | `at >= dI` |
| 電動機 | 設計電流 × 1.25 以上の最小 AT | `at >= dI * 1.25` |

### 11-3. 親幹線の MCCB 選定

| 条件 | 選定基準 |
|------|---------|
| 電動機混在 | 合計電流 × 1.25 以上の最小 AT |
| 電動機なし | 合計電流以上の最小 AT |

**上限制約**: 全定格を超える場合は最大値（800AT）を選定

**種別**: H

**根拠**: JIS C 8201-2-1, 電技解釈第 148 条, spec §8-6

---

## 12. ケーブルサイズ選定の 3 条件制約

`runCalc`（L276）で実装。小さいサイズから順に走査し、**3 条件すべて**を満たす最小サイズを選定する。

### 条件 1: 許容電流（Step 1）

```
実効許容電流 = 基本許容電流 × 温度補正係数 × 低減率
実効許容電流 ≧ サイジング電流
```

- 基本許容電流は配線方式 × ケーブル種類 × サイズで決まるテーブル値
- データが null（未整備）のサイズはスキップ

### 条件 2: 電圧降下（Step 2）

```
e = K × I × (L / 1000) × Z  [V]
Z = R × cosθ + X × sinθ      [Ω/km]
電圧降下率 = e / baseV × 100  [%]
電圧降下率 ≦ 許容値（§7 参照）
```

- インピーダンスデータが null のサイズはスキップ

### 条件 3: 保護協調（Step 3）

| 回路種別 | 合格条件 |
|---------|---------|
| 一般 | 実効許容電流 ≧ MCCB AT |
| 電動機 | 実効許容電流 ≧ MCCB AT / 2.5 |

### フォールバック

1. 単線で全サイズ不適合 → **325mm² × 2 条並列** を試行
2. 並列でも不適合 → NG 判定（`ok: false`）
3. インピーダンス / 許容電流データが存在しない → 最大サイズで NG

**種別**: H（3 条件すべて必須）

**根拠**: 電技解釈第 148 条, 内線規程 JEAC 8001, spec §8-3

---

## 13. 親幹線（幹線ノード）の制約

`runParentCalc`（L405）, `runTrunkCalc`（L598）, `aggregateCurrents`（L548）で実装。

### 13-1. 生成条件

- 同一幹線名で子回路が **2 件以上** 登録されると自動生成（旧モデル）
- ツリーモデルでは `trunk` ノードとして手動追加

### 13-2. 電流集計

```
ΣIM = 配下の電動機回路の設計電流合計
ΣIH = 配下の一般回路の設計電流合計
totalI = ΣIM + ΣIH
```

- 子に trunk ノードがある場合は再帰的に集計（`aggregateCurrents`）
- `totalI = 0` のとき計算しない（null を返す）

### 13-3. 電気方式の継承

- 幹線ノードは配下の最初の子ノードの電気方式・電圧・周波数・供給方式を継承

### 13-4. 親子不一致チェック

`calculateAll` ステップ 9（L1031–1060）で実装:
- load と親 trunk の電気方式 / 電圧が不一致 → `systemMismatch = true`, `ok = false`
- trunk 同士の不一致 → 同上
- trunk と親 transformer の電圧不一致 → 同上

**種別**: H

---

## 14. 分岐ブレーカー省略条件

`checkBranchBreaker(IW, IB, branchLength, hasBranchLine)`（L575）で実装。

| 条件 | 省略可否 | ルール名 |
|------|---------|---------|
| IW ≧ IB × 55% | 省略可（長さ制限なし） | イ号（55%条件） |
| IW ≧ IB × 35% かつ L ≦ 8m | 省略可 | ロ号（35%・8m条件） |
| L ≦ 3m かつ 負荷側に幹線分岐なし | 省略可 | ハ号（3m・末端条件） |
| 上記いずれにも該当しない | 省略不可 | — |

- IW: 分岐幹線の実効許容電流 [A]
- IB: 電源側（親幹線）MCCB の定格電流 [AT]
- L: こう長（上位接続点〜分岐点の距離）[m]

**種別**: H（省略不可の場合は警告表示）

**根拠**: 電技解釈第 148 条第 4 号

---

## 15. 配電系統ツリーの構造制約

`validateNode`（L125）で実装。

### 15-1. 深さ制約

```
depth ≦ 3（ルート = 0 起算）
```

| Level | ノードタイプ | 説明 |
|-------|------------|------|
| 0 | `transformer` | ルート（変圧器） |
| 1 | `trunk` | 主幹 |
| 2 | `trunk` | 副幹（任意） |
| 3 | `load` | 負荷回路 |

### 15-2. ノード配置制約

| 制約 | 条件 | 種別 |
|------|------|------|
| transformer は Level 0 のみ | `node.type === 'transformer' && depth !== 0` → エラー | H |
| trunk は transformer の下のみ | `node.type === 'trunk' && depth < 1`（transformer がある場合） | H |
| load は trunk の直接の子のみ | 親が trunk でなければエラー | H |
| transformer なしの trunk もルートに許容 | 後方互換 | S |

### 15-3. ノード操作制約

| 操作 | 制約 |
|------|------|
| `addNode` | `validateNode` を通過しなければ追加されない |
| `updateNode` | **タイプ変更不可**（`type: n.type` で上書き防止、L144） |
| `removeNode` | 子孫を再帰的に削除（L147–151） |

**種別**: H

**根拠**: spec §18-3

---

## 16. 変圧器ノードの制約

`calcTransformer(tr)`（L525）, `DEFAULT_TR_PARAMS`（L2283）で実装。

### 16-1. 入力選択肢

| 項目 | 選択肢 |
|------|--------|
| 変圧器種別 | 三相油入 / 単相油入 / モールド |
| 一次電圧 [V] | 3300 / 6600 |
| 二次電圧 [V] | 105 / 210 / 420 |
| 結線方式 | Δ-Y / Y-Y / Δ-Δ / Y-Δ / V-V |

### 16-2. 容量の選択肢 [kVA]

| 種別 | 容量 |
|------|------|
| 三相油入 | 50, 75, 100, 150, 200, 300, 500, 750, 1000, 1500, 2000 |
| 単相油入 | 10, 20, 30, 50, 75, 100, 150, 200, 300, 500 |
| モールド | 50, 75, 100, 150, 200, 300, 500, 750, 1000, 1500, 2000 |

### 16-3. %Z / X/R 比の自動決定

- 容量選択時に `pctZAuto === true` であれば `transformer-ratings.json` の対応値を自動セット
- カスタム入力で上書き可能

### 16-4. モールド変圧器の特別制約

- %Z に min/max の範囲がある（製造ばらつき保証範囲）
- **短絡電流計算**: min 値を使用（最大電流側 = 保守的）
- **電圧降下計算**: max 値を使用（保守的）

### 16-5. 計算式の制約

```
X/R 比が提供されている場合:
  %R = %Z / √(1 + (X/R)²)
  %X = %R × (X/R)
  Rs = (%R / 100) × Vs² / S
  Xs = (%X / 100) × Vs² / S

X/R 比が未提供の場合:
  Rs = (%Z / 100) × Vs² / S
  Xs = 0（全て抵抗分 = 保守側）
```

### 16-6. 電圧継承

- 変圧器の `secondaryV` は配下全ノードの `voltage` として継承
- 変圧器が存在する場合、`supplyType` は自動的に「高圧受電」

**種別**: H

**根拠**: spec §19, JIS C 4304, JEC 2200

---

## 17. 短絡電流計算の制約

`calcFaultCurrents`（L726）, `propagateFault`（L749）で実装。

### 17-1. R+jX ベクトル累積方式

電圧降下計算のスカラー式（`Z = R·cosθ + X·sinθ`）とは **異なる方式** を使用する:

```
Rtotal = Rsrc + ΣRc_i（R 成分を独立累積）
Xtotal = Xsrc + ΣXc_i（X 成分を独立累積）
|Ztotal| = √(Rtotal² + Xtotal²)
Isc₃ = Vs / (√3 × |Ztotal|)
```

### 17-2. トップダウン累積

ルート（変圧器）→ リーフ（負荷回路）の順に計算:

1. 変圧器: `Zsrc = √(Rs² + Xs²)`
2. HV ケーブル加算（存在する場合）: `Rsrc += Rhv × (Vs/Vp)²`
3. 各ケーブル区間: `Rc = R [Ω/km] × L [km] / 並列数`

### 17-3. 並列ケーブルの制約

並列ケーブルのインピーダンスは並列数で除算: `Rc = R × L / parallel`（L767）

**種別**: H

**根拠**: spec §20-2, §20-3

---

## 18. 短時間耐電流（熱耐量）の制約

`checkWithstand(size_mm2, Isc3, t, parallel)`（L779）で実装。

### 18-1. 検証式

```
Isc₃ ≦ K × A × parallel / √t

ここで:
  K = 134（銅導体 / XLPE 絶縁: CV, CVT）
  A = 導体断面積 [mm²]
  t = 短絡継続時間 [s]（デフォルト 0.1s）
```

### 18-2. K 定数（`data/short-time-withstand.json`）

| 導体 / 絶縁 | K |
|-------------|---|
| 銅 / XLPE（CV, CVT） | 134 |
| 銅 / PVC（VV） | 97 |
| 銅 / PE | 98 |
| 銅 / EP | 140 |
| アルミ / XLPE | 90 |
| アルミ / PVC | 64 |

現在コードでは `K = 134` がハードコード（L782）。

**種別**: H（NG の場合は必要最小ケーブルサイズを表示）

**根拠**: JCS 0168-1:2016

---

## 19. 遮断容量チェックの制約

`getIcu(at, voltage, icuClass)`（L800）, `calculateAll` ステップ 6（L994–1005）で実装。

### 19-1. 検証条件

```
Icu ≧ Isc₃
```

### 19-2. フレーム別遮断容量 [kA]（`data/mccb-icu.json`）

| フレーム | 定格 [AT] | 230V (std/high) | 415V (std/high) |
|---------|----------|-----------------|-----------------|
| 30AF | 5, 10, 15, 20, 30 | 2.5 / 5 | 2.5 / 5 |
| 50AF | 15, 20, 30, 40, 50 | 5 / 10 | 5 / 7.5 |
| 100AF | 50, 60, 75, 100 | 10 / 25 | 10 / 25 |
| 225AF | 100, 125, 150, 175, 200, 225 | 25 / 50 | 25 / 36 |
| 400AF | 250, 300, 350, 400 | 36 / 65 | 36 / 50 |
| 630AF | 500, 600, 630 | 50 / 85 | 42 / 65 |
| 800AF | 700, 800 | 65 / 100 | 50 / 85 |

### 19-3. 電圧判定

```
voltage <= 230 → '230V' テーブル
voltage > 230  → '415V' テーブル
```

**既知の制限**: MCCB 定格 25, 32, 63 AT はどのフレームにも含まれず、遮断容量を取得できない（pending-issues.md 参照）

**種別**: H

**根拠**: JIS C 8201-2-1, spec §20-4a

---

## 20. 地絡電流・接地の制約

### 20-1. HV 側一線地絡電流（`calcGroundFaultCurrent`、L812）

```
Ig = 3ωCV = 3 × 2πf × C_total × (V / √3)
```

- `C_total = capacitance_uF_per_km × totalCableLength_km × 10⁻⁶`
- HV パラメータが null の場合は計算しない

### 20-2. B 種接地抵抗上限（`calcGroundingResistance`、L825）

| VCB 遮断時間 | 接地抵抗上限 |
|-------------|-------------|
| 0.5 秒以内 | Rb ≦ 150 / Ig [Ω] |
| 1.0 秒以内 | Rb ≦ 600 / Ig [Ω] |
| 2.0 秒以内 | Rb ≦ 300 / Ig [Ω] |

### 20-3. LV 側地絡電流（`calcLVGroundFault`、L851）

対称座標法による推定:

```
Ig_lv = 3 × Ea / |2×Z₁ + Z₀|
Ea = Vs / √3
Z₀ = Z₁ × 零相比 + Z_transformer × 結線乗数
```

零相インピーダンス比（`data/zero-sequence.json`）:

| ケーブル種類 | R0/R1 | X0/X1（典型値） |
|------------|-------|-----------------|
| 多心（CV-3C, CV-2C） | 4.0 | 4.0 |
| 単心（CVT, CVD） | 1.0 | 1.15 |

変圧器結線方式の乗数:

| 結線 | 内部キー | 乗数 |
|------|---------|------|
| Δ-Y | Dyn | 1.0 |
| Y-Y | Yyn | 5.0 |
| Δ-Δ | Dd | null（零相電流なし） |
| Y-Δ | Dd | null（零相電流なし） |
| V-V | Dyn | 1.0 |

**種別**: H

**根拠**: 電技解釈第 17 条, IEC 60909, CENELEC CLC/TR 50480

---

## 21. ELCB 保護協調の制約

`checkELCB(loadParams, Ig_lv)`（L896）で実装。

### 21-1. TT 系統

```
RA × IΔn ≦ 50V

RA: 接地抵抗 [Ω]（デフォルト 100Ω）
IΔn: ELCB 感度電流 [A] = elcbSensitivity_mA / 1000
```

### 21-2. TN 系統

- TN 系統では Ig_lv が存在すれば OK 判定

**種別**: H

**根拠**: JIS C 8201-2-2:2021, spec §20-8

---

## 22. データテーブルの構造制約

### 22-1. 許容電流データの完全性

`data/ampacity-*.json` のデータ充足状況:

| ケーブル種類 | ラック | 配管 | 直埋 | 管路 |
|------------|--------|------|------|------|
| CVT | **完全**（10） | 部分（6/10） | **完全**（10） | **空** |
| CVD | **完全**（10） | **空** | **完全**（10） | **空** |
| CV-3C | **完全**（13） | **完全**（13） | **空** | 部分（9/13） |
| CV-2C | **完全**（13） | **完全**（13） | **空** | **空** |

- データが未整備の組合せでは `getBaseAmpacity` が `null` を返し、そのサイズはスキップされる
- ケーブルラック配線のみ全ケーブル種類で完全なデータを保有

**既知の制限**: pending-issues.md Issue 2 に欠損一覧あり

### 22-2. インピーダンスデータの範囲

| テーブル | サイズ範囲 | 周波数 |
|---------|-----------|--------|
| IMP_CV（CV-2C, CV-3C） | 2〜325mm² | 50Hz / 60Hz |
| IMP_CVT（CVT, CVD） | 8〜325mm² | 50Hz / 60Hz |
| IMP_HV（高圧 6600V） | CV-3C: 14〜325mm², CVT: 22〜325mm² | 50Hz / 60Hz |

### 22-3. MCCB フレーム割当の不整合

- `mccb-ratings.json` の 25, 32, 63 AT は `mccb-icu.json` のどのフレームにも含まれない
- `mccb-icu.json` の 30AF フレームに含まれる 5, 10 AT は `mccb-ratings.json` に存在しない

**種別**: H（実行時にデータ欠損としてスキップ / null 返却で処理）

---

## 23. 登録・更新・削除の制約

spec §13 で定義。

### 23-1. 登録の前提条件

| 条件 | 種別 |
|------|------|
| 幹線番号 / 名称が空でないこと | H |
| 負荷容量 > 0 | H |
| こう長 > 0 | H |
| 計算結果が存在すること | H |

### 23-2. 自動生成 / 削除

- 同一幹線名で 2 件目登録 → 親幹線が初期値で自動生成
- 削除で同一幹線名が 1 件以下 → 親幹線行が自動消滅

### 23-3. ノード操作制約

- ノードのタイプ変更は不可
- ノード削除は子孫を再帰的に削除

**種別**: H

---

## 24. Import/Export の制約

spec §14, L5427 以降で実装。

| 制約 | 内容 | 種別 |
|------|------|------|
| Export ファイル名 | `幹線計算_YYYY-MM-DD.json` | S |
| Export バージョン | `'P5'`（基本）, `'M2G'`（グループ付き） | H |
| 旧形式互換 | 配列のみの旧形式もインポート可能 | H |
| M2 形式からの移行 | `groups` を自動生成、`crossLinks` は空配列 | H |

---

## 25. UI 動作の制約

spec §2, §6, §7 で定義。

### 25-1. 入力確定タイミング

| 入力タイプ | トリガー | 対象 |
|-----------|---------|------|
| セレクトボックス | `onChange`（即時反映） | 電気方式, 電圧, 周波数, 供給方式, 回路種別, ケーブル種類 等 |
| 数値入力 | `onBlur`（フォーカスアウト時） | 負荷容量, こう長, 力率, 効率, 需要率, 温度, 低減率 |

### 25-2. 連動制御

| トリガー | 動作 |
|---------|------|
| 電気方式変更 | 電圧選択肢・ケーブル種類選択肢をリセット |
| 回路種別を「一般」に | 効率を 1.0 にリセット、入力欄非表示 |
| 多条低減プリセット変更 | 対応する低減率を自動セット |
| 配線方式変更 | 温度補正テーブルを切替（気中 / 地中） |

### 25-3. レイアウト

| 項目 | 値 |
|------|-----|
| 左ペイン幅 | 460px 固定 |
| 右ペイン幅 | 残り幅 |
| ペイン | 独立スクロール |

**種別**: H（UI 仕様として）

---

## 26. アーキテクチャ制約

CLAUDE.md で定義。

| 制約 | 内容 | 種別 |
|------|------|------|
| 単一 HTML ファイル出力 | ビルドにより `index.html` を生成 | H |
| クライアントサイド完結 | サーバー処理なし、オフライン動作 | H |
| localStorage 非依存 | JSON import/export で永続化 | H |
| データソース | `data/*.json` が唯一の原本。手動コピー禁止 | H |
| ライブラリ追加 | CDN 経由のみ。npm / ビルドツール不使用 | H |
| ビルドスクリプト | Node.js 標準ライブラリのみ。npm install 不要 | H |
| 計算精度 | 精密式（R·cosθ + X·sinθ）を常に使用。簡略式フォールバック禁止 | H |
| テーブルデータ | `data/` JSON が原本。ビルド時に `/* __DATA__ */` マーカーに注入 | H |

---

## 27. 警告ヒントの閾値

`getHints()`（L3240 付近）, `getTransformerHints()`（L3300 付近）で実装。

計算結果がエラーではないが注意が必要な場合に表示されるヒントの閾値:

| 項目 | 閾値 | 条件 | 種別 |
|------|------|------|------|
| 電圧降下 | 許容値の 80% 以上 | `vdPercent >= allowVdPercent * 0.8` | S |
| 累積電圧降下 | 許容値の 70% 以上 | `cumulativeVdP >= allowVdPercent * 0.7` | S |
| 保護協調マージン | 15% 未満 | `margin >= 1 && margin < 1.15` | S |
| 変圧器利用率（高） | 80% 以上 | `utilization >= 80` | S |
| 変圧器利用率（低） | 0% 超 30% 以下 | `utilization > 0 && utilization <= 30` | S |

---

## 28. 計算パイプラインの実行順序制約

`calculateAll(nodes, feedLinks)`（L928）で定義。計算は以下の順序で厳密に実行される:

| ステップ | 方向 | 内容 | 依存関係 |
|---------|------|------|---------|
| 1 | ボトムアップ | 全 load ノード計算（`runCalc`） | なし |
| 2 | ボトムアップ | 全 trunk ノード計算（深い順、`runTrunkCalc`） | ステップ 1 |
| 2.5 | ボトムアップ | feedLink 容量同期 + 祖先 trunk 再計算 | ステップ 1, 2 |
| 3 | — | transformer ノード計算（`calcTransformer`） | なし |
| 4 | トップダウン | 累積電圧降下（`calcCumulativeVd`） | ステップ 1–3 |
| 5 | トップダウン | 短絡電流（`calcFaultCurrents`） | ステップ 3 |
| 6 | — | 遮断容量チェック | ステップ 5 |
| 7 | — | HV 側地絡電流 + B 種接地 | ステップ 3 |
| 8 | — | ELCB 保護協調 + LV 側地絡電流 | ステップ 5 |
| 9 | — | 電気方式 / 電圧の親子不一致チェック | ステップ 1–3 |
| 10 | — | 分岐ブレーカー省略条件判定 | ステップ 1–3 |
| 11 | — | feedLink 接続情報アノテーション | ステップ 2.5 |

**種別**: H（実行順序の変更は計算結果の正確性に影響する）

---

## 29. フィードリンク（feedLink）の制約

系統図のダイアグラムエディタで作成されるフィードリンク（負荷→幹線間の給電接続）。

### 29-1. 接続検証

| 制約 | 内容 | コード位置 |
|------|------|-----------|
| ソース | `load` ノード、または子 trunk を持たない末端 `trunk` ノードのみ | L1856–1860 |
| ターゲット | depth=1 の `trunk` ノードのみ | L1862 |
| 同一ツリー禁止 | ソースとターゲットが同一ルート変圧器配下の場合は接続不可 | L1864–1865 |

### 29-2. 容量同期

- feedLink が存在する場合、ソース load の `dI` はターゲット trunk の `totalI` で上書きされる（L962）
- 上書き後、ソースの祖先 trunk は再帰的に再計算される（L969–977）

### 29-3. カスケード削除

- ノード削除時、そのノードを参照する feedLink は自動削除（L5479）

**種別**: H

---

## 30. ダイアグラム（系統図）の制約

### 30-1. ズーム制約

| 項目 | 最小値 | 最大値 | コード |
|------|--------|--------|--------|
| ズームスケール | 0.1 | 5.0 | L1764 |
| フィットビューの最大スケール | — | 2.0 | L1947 |

### 30-2. モジュールサイズ定数（`MOD`、L1123–1132）

| モジュール | 幅 [px] | 高さ [px] |
|-----------|---------|----------|
| transformer | 200 | 80 |
| trunk | 260 | 80 |
| load | 220 | 70 |
| receive（受電点） | 100 | 50 |

| 間隔パラメータ | 値 [px] | 説明 |
|--------------|---------|------|
| GAP_MAIN | 120 | 主軸方向の間隔 |
| GAP_CROSS | 20 | 兄弟間の間隔 |
| MARGIN | 40 | 余白 |
| PORT_R | 5 | ポート半径 |

### 30-3. 操作制約

| 制約 | 内容 |
|------|------|
| transformer ノードはドラッグ不可 | クリックするとパン操作に切替（L5903–5906） |
| クリック判定閾値 | マウス移動量 < 4px はクリックとして扱う（L1835） |
| ポート接続判定半径 | 15px 以内でヒット検出（L1853） |

### 30-4. 描画方向フレームワーク

| 方向 | 主軸 | 交差軸 | 入力ポート | 出力ポート |
|------|------|--------|-----------|-----------|
| horizontal（デフォルト） | x | y | left | right |
| vertical（予約） | y | x | top | bottom |

**種別**: S（UI 表示制約）

---

## 31. 丸め精度の制約

`rd(v, n)`（L268）で実装。

| 計算値 | 小数点以下桁数 |
|--------|--------------|
| 設計電流 dI | 2 桁 |
| サイジング電流 sizingI | 2 桁 |
| 温度補正係数 tempFactor | 3 桁 |
| インピーダンス Z | 4 桁 |
| 電圧降下 vd | 2 桁 |
| 電圧降下率 vdPercent | 2 桁 |
| 累積電圧降下 cumulativeVd | 2 桁 |
| 分岐ブレーカー比率 | 1 桁 |
| 接地抵抗上限 Rb | 1 桁 |
| LV 地絡電流 Ig_lv | 2 桁 |

**種別**: S（表示精度。計算途中は浮動小数点のまま処理）

---

## 32. 自動削除・カスケード削除の制約

| トリガー | 自動削除される対象 | コード |
|---------|------------------|--------|
| load 削除で親 trunk の子が 0 件に | 空の親 trunk を自動削除 | L5465–5467 |
| ルートノード削除 | 関連する group と crossLink を削除 | L5472–5476 |
| ノード削除 | 参照する feedLink を削除 | L5479 |
| `removeNode` 実行 | 子孫ノードを再帰的に削除 | L147–151 |

**種別**: H

---

## 付録 A: 準拠規格一覧

| 規格・法規 | 適用範囲 |
|-----------|---------|
| 内線規程 JEAC 8001 | 許容電圧降下（1310節）、電動機回路の幹線太さ基準（3705節） |
| 電技解釈 第148条 | 低圧幹線の施設（許容電流、MCCB定格、保護協調、分岐CB省略） |
| 電技解釈 第17条 | B種接地工事 |
| JCS 0168-1/2:2016 | ケーブル許容電流計算、短時間耐電流 K 定数 |
| 技資第103号A | CV ケーブルインピーダンス表（導体温度 90℃） |
| JIS C 3605 / C 3606 | 600V CV ケーブル / CVT ケーブル規格 |
| JIS C 8201-2-1 | 配線用遮断器（MCCB）規格 |
| JIS C 8201-2-2:2021 | 漏電遮断器（ELCB）規格 |
| JIS C 4304 / JEC 2200 | 変圧器規格 |
| IEC 60909 | 短絡電流計算 |
| CENELEC CLC/TR 50480 | 零相インピーダンス推定 |

---

## 付録 B: 既知の制限事項

| # | 内容 | 参照 |
|---|------|------|
| 1 | MCCB `3×ΣIM+ΣIH` 上限チェック未実装 | pending-issues.md Issue 1 |
| 2 | 許容電流データの欠損（配管/直埋/管路の複数組合せ） | pending-issues.md Issue 2 |
| 3 | 400/500mm² ケーブルサイズ未対応 | pending-issues.md Issue 3 |
| 4 | MCCB 定格 25/32/63 AT のフレーム割当なし（遮断容量取得不可） | §22-3 |
| 5 | モールド変圧器の X/R 比データなし | §16-4 |
| 6 | 温度補正の対応範囲が 20〜50℃ に限定 | §9 |
