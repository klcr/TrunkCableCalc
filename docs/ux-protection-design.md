# 保護設計の可視化 — UX 設計思想

## 背景と動機

低圧幹線ケーブル計算ツールは、許容電流・電圧降下・保護協調の 3 条件によるケーブルサイズ自動選定を中核機能とする。これに加え、短絡電流（Isc₃）の R+jX ベクトル累積計算、ケーブル熱耐量チェックが P4 で実装済みである。

M2-3 以降で実装する一線地絡電流・遮断容量チェック・ELCB 保護協調は、単に「計算機能の追加」ではなく、ツール全体の保護設計体験を設計する機会である。本文書は、これらの機能をどのようなユーザー体験に昇華させるかの設計思想を記録する。

## 核心的なインサイト

### ノード視点と経路視点

現在のツールは「**ノード単位の条件チェック**」が設計の骨格である。各回路の結果パネルに OK/NG バッジが並び、エンジニアはノードごとに合否を確認する。

しかし短絡・地絡の世界には、もう一つの軸がある —— 「**経路に沿った保護の連続性**」である。

変圧器直下では数十 kA の短絡電流が、ケーブルインピーダンスの累積により下流へ行くほど減衰する。その減衰の途中で、MCCB の遮断容量、ケーブルの熱耐量、ELCB の感度がそれぞれ「しきい値の壁」として現れる。

**この「経路としきい値の壁の関係」を一画面で見せること**が、プロファイルカーブの本質的な価値である。

### 二つの保護レイヤー

実装する機能群は性質が異なり、二つのレイヤーに分かれる:

| レイヤー | 特性 | 代表的な機能 |
|---------|------|-------------|
| **ノード単位チェック** | 各保護デバイスの個別照合 | 遮断容量（Icu ≥ Isc₃）、熱耐量、ELCB 保護協調 |
| **系統レベル特性** | 変圧器/系統全体で決まる値 | 一線地絡電流（Ig）、B種接地抵抗（Rb） |

ノード単位チェックは既存の OK/NG バッジパターンを拡張する。系統レベル特性は変圧器パネルに集約する。プロファイルカーブは両レイヤーを統合し、経路全体の保護状況を俯瞰するビューとなる。

## 設計決定

### D1: プロファイルカーブを右ペイン新タブとして実装する

**決定**: 右ペインに `[テーブル] [系統図] [分割] [プロファイル]` の 4 番目のタブを追加する。

**根拠**: プロファイルカーブは既存のどのビューとも異なる情報次元（経路×短絡電流レベル）を提示する。タブとして独立させることで、テーブルや系統図の情報密度を増やさずに新しい視点を提供できる。

**却下した代替案**:
- 系統図上のオーバーレイ: キャンバスの描画複雑度が増し、系統図本来の見やすさを損なう
- 結果パネル内の展開: 経路全体を俯瞰する目的と、ノード詳細を表示する結果パネルの性質が合わない

### D2: プロファイルカーブが自然にマージンを表現する

**決定**: OK/NG バッジへの「マージン比」色分け導入は見送り、プロファイルカーブによる視覚的マージン表現を優先する。

**根拠**: プロファイルカーブでは、Isc₃ 減衰曲線としきい値線の「距離」がそのままマージンの視覚表現になる。追加のしきい値パラメータ設定やその規格的根拠の議論が不要で、エンジニアが直感的に余裕度を把握できる。

バッジレベルのマージン表示は、プロファイルカーブの利用実績を見た上で、将来的に検討する。もし数値化する場合は、TreeTable の Isc₃ 列隣に `Icu/Isc₃` 比を控えめに表示する程度から始める。

**懸念と対処**:
- 電気設計では JCS/JIS の基準を満たすかどうかが最終判定。余裕度のしきい値に規格的根拠がない
- 「黄色」表示が不要なサイズアップを誘発する恐れ
- → プロファイルカーブなら「距離」として自然に見え、判定色による誤解が生じにくい

### D3: 遮断容量チェックは簡易照合方式を採用する

**決定**: ユーザーが MCCB 選定時に遮断容量クラス（経済型 / 高遮断型など）を選択し、Icu が自動決定される簡易照合方式とする。

**根拠**: 遮断容量は MCCB のフレームサイズ・電圧・性能クラスで一意に決まる。ユーザーが個別に Icu を手入力するよりも、クラス選択からの自動決定が入力負荷・整合性の両面で優れる。

**必要なデータ**: `data/mccb-icu.json`（新規）に、フレーム別・電圧別・クラス別の遮断容量テーブルを整備する。出典は JIS C 8201-2-1 および主要メーカーカタログ。

**表示**: 各ノードの結果パネル「短絡電流」セクションに `遮断容量 Icu [kA] ≥ Isc₃ [kA]` 行を追加。OK/NG バッジは既存パターンに準拠。

### D4: B種接地抵抗は変圧器パネルに表示する

**決定**: TransformerResultPanel に「接地設計」セクションを追加し、一線地絡電流 Ig と B種接地抵抗上限 Rb を表示する。

**根拠**: B種接地抵抗は変圧器の属性。系統全体のケーブル対地静電容量と周波数から決まり、下流の個別回路には依存しない。変圧器パネルが自然な居場所。

**表示内容**:
```
接地設計
──────────────────────────
一線地絡電流  Ig = 5.23 A
  3ωCV = 3 × 2π × 60 × C × V/√3

B種接地抵抗上限
  0.5秒以内遮断  Rb ≤ 28.7 Ω   (150/Ig)
  1.0秒以内遮断  Rb ≤ 114.8 Ω  (600/Ig)
```

**入力**: 変圧器フォームの hvSystem セクション（M2-2 で追加）のケーブル静電容量パラメータ、または系統対地静電容量の直接入力。

### D5: ELCB 保護協調は load ノードの条件付きセクションとする

**決定**: load フォームに「ELCB 有無」「感度電流 IΔn」「接地方式」フィールドを追加し、ResultPanel に条件付き「地絡保護」セクションを表示する。

**根拠**: ELCB は回路単位の保護デバイス。load ノードの属性として自然に収まる。TT系統の `RA × IΔn ≤ 50V` 検証は、その回路の接地条件に依存するためノードレベルのチェック。

### D6: 表示の抽象化は将来のヒートマップの布石として設計する

**決定**: 系統図キャンバスの短絡電流ヒートマップは、セマンティックズームの概念で設計する。ただし M2-3 では実装せず、プロファイルカーブを優先する。

**根拠**: ヒートマップ的な色分けは「系統全体の俯瞰」のために必要だが、そのためには表示の抽象化（ズームレベルに応じた情報密度の制御）が前提となる。プロファイルカーブは「深さ方向」の理解、ヒートマップは「幅方向（並列系統間の比較）」の理解を支援し、相補的な関係にある。

**セマンティックズームの将来設計**:

| ズームレベル | 表示内容 | 目的 |
|-------------|---------|------|
| 俯瞰 | 変圧器系統ごとに 1 ブロック。最悪ケースの色 | 「どの系統に問題があるか」 |
| 系統 | 幹線区間ごとに色帯。保護ゾーン境界線 | 「どの階層がタイトか」 |
| 詳細 | 現在の全アノテーション表示 | 「具体的な値の確認」 |

## プロファイルカーブ 詳細設計

### 概要

変圧器から末端負荷回路への経路に沿って、短絡電流の減衰曲線と各種保護しきい値を重ね描きする SVG チャート。

### レイアウト

```
┌─────────────────────────────────────────────────┐
│ [テーブル] [系統図] [分割] [■プロファイル]           │
├─────────────────────────────────────────────────┤
│                                                   │
│  経路: TR-1 → 主幹 → 副幹A → L-03    [◀ ▶]     │
│                                                   │
│  Isc₃                                            │
│  [kA]                                             │
│   25 ┤■ TR-1                                      │
│      │  ╲                                         │
│      │   ╲                                        │
│   15 ┤    ╲                                       │
│      │     ╲                                      │
│      │     ── Icu = 25kA ─────────────── (MCCB)  │
│    8 ┤      ■ 主幹                                │
│      │       ╲                                    │
│      │        ── Iw = 6.7kA ────────── (38sq耐量) │
│    4 ┤         ■ 副幹A                            │
│      │          ╲                                  │
│    2 ┤           ■ L-03                           │
│      │                                             │
│      │       Ig(LV) = 0.8kA ─ ─ ─ ─ ─ (地絡)     │
│      └──────────────────────────────── 経路        │
│                                                   │
│  ☑ 遮断容量 (Icu)   ☑ ケーブル耐量 (Iw)           │
│  ☐ 地絡電流 (Ig)    ☐ ELCB感度                    │
│                                                   │
└─────────────────────────────────────────────────┘
```

### 構成要素

#### 主曲線: Isc₃ 減衰

- 各ノードの利用可能短絡電流を折れ線で接続
- X 軸はツリー上の経路位置（等間隔配置、ノード名ラベル付き）
- Y 軸は電流 [kA]（対数スケールを基本とし、線形スケール切替可能）
- ノード点はクリッカブル。クリック → 左ペインにそのノードの編集フォーム展開

#### しきい値線

| 線種 | データソース | 表示条件 |
|------|-------------|---------|
| Icu（遮断容量）| 各ノードの MCCB フレーム/クラスから決定 | 遮断容量データ設定時 |
| Iw（ケーブル熱耐量）| K × A × √parallel / √t | 常時 |
| Ig(LV)（LV 側地絡電流）| 対称座標法算出値 | M2-3 実装後 |
| IΔn（ELCB 感度電流）| ELCB スペックテーブル | ELCB 設定回路のみ |

しきい値線はノードの区間ごとに水平線として描画（各ノードで使用する MCCB/ケーブルが異なるため、値がステップ的に変化する）。

#### 交差点の強調

- Isc₃ がしきい値線を**下回る**点: 安全確認マーク（控えめな緑ドット）
- Isc₃ がしきい値線を**上回る**点: 警告マーク（赤ドット + ツールチップで詳細）
- 上回る = 保護機器の能力不足を意味する

#### チェックボックス

チャート下部にレイヤー表示トグル。デフォルトは Icu と Iw を ON。

### 経路選択

ツリー構造のため、変圧器から末端への経路は複数存在する。

- **自動選択**: TreeTable の行クリック時、そのノードから変圧器（ルート）までの経路を自動選択してプロファイルタブに反映
- **手動切替**: ◀ ▶ ボタンで同一変圧器配下の末端（leaf）ノード間を巡回
- **複数経路比較**: 将来拡張として、2 本の経路を半透明で重ね描きし、分岐後の差異を比較可能にする

### ホバー/ツールチップ

ノード点にホバーすると、そのノードの主要値をツールチップ表示:

```
┌─────────────────────────┐
│ 副幹A                    │
│ Isc₃ = 4.2 kA           │
│ Icu  = 25 kA (余裕 ×5.9) │
│ Iw   = 6.7 kA (余裕 ×1.6)│
│ CVT 38sq × 15m          │
└─────────────────────────┘
```

ツールチップ内にマージン比（余裕 ×N.N）を表示する。これにより、チャート全体の色分けなしに数値的マージンを確認できる。

### 描画技術

- SVG ベース。React コンポーネントとして実装
- 既存の系統図キャンバス（DiagramCanvas）とは独立した、より単純な描画コンポーネント
- レスポンシブ: 右ペインの幅に追従
- 印刷/PDF 出力時にプロファイルを含めるかはオプション（将来検討）

## 情報アーキテクチャ全体像

```
変圧器パネル
├── 既存: 定格電流 / Isc₃ / 利用率 / ソースインピーダンス
└── NEW: 接地設計（Ig / Rb 上限）

ノード結果パネル（trunk / load）
├── 既存: 許容電流 / 電圧降下 / 保護協調 / 短絡電流 / 熱耐量
├── NEW: 遮断容量チェック（Icu ≥ Isc₃、簡易照合）
└── NEW: 地絡保護（ELCB 設定回路のみ、条件付き表示）

プロファイルタブ（右ペイン新タブ）
├── 主曲線: Isc₃ 減衰
├── しきい値線: Icu / Iw / Ig / IΔn
├── 経路選択（自動連動 + 手動切替）
└── レイヤー表示トグル

系統図キャンバス（将来拡張）
└── セマンティックズームによる短絡電流ヒートマップ
```

## 実装優先順位

1. **プロファイルカーブ**: 既存の Isc₃ / Iw データで動作する。新しい計算ロジック不要で UI のみ
2. **遮断容量チェック（簡易照合）**: `mccb-icu.json` データ整備 + UI + 照合ロジック
3. **B種接地抵抗 / 一線地絡電流**: M2-2（HV モデリング）と連動。hvSystem データが前提
4. **ELCB 保護協調**: LV 側地絡電流計算（対称座標法）の実装が前提
5. **セマンティックズーム / ヒートマップ**: プロファイルカーブの利用実績を見て判断

## 設計原則

1. **経路視点を導入する**: ノード単位チェックと経路俯瞰ビューの二層構造
2. **プロファイルカーブにマージン表現を委ねる**: バッジの色分け拡張より、曲線と壁の距離で自然に伝える
3. **系統特性は変圧器に集約する**: Ig, Rb は変圧器の属性として表示
4. **既存パターンを拡張する**: 遮断容量・ELCB は既存 OK/NG バッジパターンの自然な延長
5. **段階的に深化する**: まず経路視点（プロファイル）、次に系統俯瞰（ヒートマップ）
