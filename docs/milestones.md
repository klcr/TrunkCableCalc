# プロジェクトマイルストーン

## Milestone 1: 低圧幹線ケーブル計算ツール

GitHub Pages で公開する単一 HTML ファイルの Web アプリケーション。
詳細仕様: [`docs/spec-cable-calc.md`](./spec-cable-calc.md)

### Phase 一覧

| Phase | 内容 | 主な成果物 | 仕様書参照 | 状態 |
|-------|------|-----------|-----------|------|
| P1 | 参照データ整備 + ビルド基盤 | `data/` JSON, `scripts/build.js`, `src/index.html` テンプレート | §10 | 完了 |
| P2 | 計算エンジン（子回路） | `runCalc` 実装（設計電流→ケーブル選定→MCCB→保護協調） | §8 | 完了 |
| P3 | UI: 入力フォーム＋結果表示 | 左右ペインレイアウト、連動制御、スライダーUI | §2,3,5,6,7,11 | 完了 |
| P4 | マルチノード配電系統＋登録管理 | 4階層ツリー、変圧器/%Z、CRUD、地絡電流 | §4,9,12,13,18,19,20 | 完了 |
| P5 | Import/Export＋PDF出力＋325×2 | JSON保存/読込、電-8-1 形式計算書出力、325×2並列ケーブル | §14,15 | 完了 |
| P6 | 検証・デプロイ | 手計算との突合、エッジケース対応、GitHub Pages 公開 | §16 | 未着手 |

### P1: 参照データ整備 + ビルド基盤

- [x] ディレクトリ構成の確定（`data/`, `src/`, `scripts/`, `docs/`）
- [x] 仕様書・マイルストーン文書の作成
- [x] 値確定データの JSON 化（MCCB定格、温度補正、低減率プリセット）
- [x] スキーマ定義（インピーダンス、許容電流）
- [x] ビルドスクリプト `scripts/build.js` の作成
- [x] GitHub Actions デプロイにビルドステップ追加
- [x] インピーダンス実データの転記（技資第103号A）
- [x] 許容電流実データの転記（JCS 0168）
- [x] `src/index.html` テンプレート作成（データプレースホルダー付き）
- [x] ビルド実行確認（`node scripts/build.js` → `index.html` 生成）

### P2: 計算エンジン（子回路）

- [x] 設計電流の算出（kW/kVA/A → A 変換、需要率適用）
- [x] 電動機回路の電流補正（≦50A: ×1.25、>50A: ×1.1）
- [x] ケーブルサイズ自動選定（許容電流→電圧降下→保護協調の3条件走査）
- [x] MCCB定格の自動選定
- [x] 電圧降下計算（精密式: R·cosθ + X·sinθ）
- [x] 許容電圧降下の判定（こう長×供給方式テーブル）
- [x] 保護協調チェック（一般: eA≧AT、電動機: eA≧AT/2.5）

### P3: UI: 入力フォーム＋結果表示

- [x] 左右2ペインレイアウト（左460px固定、独立スクロール）
- [x] 子回路入力フォーム（回路情報・負荷条件・ケーブル条件）
- [x] 連動制御（電気方式↔電圧、回路種別↔効率、配線方式↔温度補正）
- [x] 入力確定タイミング制御（onChange / onBlur の2層管理）
- [x] スライダーポップアップUI
- [x] 選定結果パネル（合否バッジ、詳細表示）
- [x] ヘッダー（ツール名称、操作ボタン群）

### P4: マルチノード配電系統＋登録管理

単一の親子関係から、変圧器→主幹→副幹→負荷回路の **4階層ツリー** へ拡張。
任意の trunk ノード末端を別ツリーの主幹として再帰的に接続可能な設計思想。
変圧器の %Z によるソースインピーダンス計算、および LV 側地絡電流計算を含む。
HV 側（対地静電容量基準）は M2-3 との統合を見据えたデータモデル準備のみ。

#### P4-1: データモデル・ツリー状態管理

- [x] ノードスキーマ定義（transformer / trunk / load の 3 タイプ）
- [x] App ステートにノード配列 `nodes` 導入
- [x] ノード CRUD 関数（genId, addNode, updateNode, removeNode）
- [x] ツリー走査ユーティリティ（getChildren, getParent, getAncestors, getDepth, buildTree）
- [x] 4 階層 depth 制約の実装
- [x] 仕様書更新（§18 配電系統ツリーモデル）

#### P4-2: 負荷回路 CRUD

- [x] 登録ボタンの有効化・バリデーション（幹線名必須、容量>0、結果存在）
- [x] 子回路の登録（nodes に load ノード追加）
- [x] 幹線名による trunk ノード自動作成（同一名 2 件以上で自動生成）
- [x] 子回路の編集（行クリック → フォーム復元 → 「更新」ボタン）
- [x] 子回路の削除（× ボタン、trunk 連動削除）

#### P4-3: ツリー表示・ナビゲーション

- [x] TreeTable コンポーネント（右ペイン下部）
- [x] ノードタイプ別表示（[TR] / [主幹] / └ インデント）
- [x] テーブルカラム（種別、名称、方式/電圧、設計電流、ケーブル、AT、電圧降下、判定、操作）
- [x] 行クリック → ノード選択 → 左ペイン切替（load / trunk / transformer の 3 モード）
- [x] + ボタンで子ノード追加

#### P4-4: 多階層幹線計算（再帰）

- [x] aggregateCurrents: 再帰的ボトムアップ電流集計（trunk の子に trunk を含む場合対応）
- [x] runParentCalc 拡張（or runTrunkCalc 新設）
- [x] calcCumulativeVd: トップダウン累積電圧降下
- [x] calculateAll: 全ノード一括計算（トポロジカルソート → useMemo）
- [x] 電動機判定の再帰的伝播（子孫に 1 つでも電動機があれば hasMotor）

#### P4-5: 変圧器ノード

- [x] data/transformer-ratings.json の拡張（河村カタログ %Z+X/R比、単相油入、モールド追加）
- [x] scripts/build.js に transformer-ratings.json → TR_RATINGS 注入追加
- [x] 仕様書更新（§19 変圧器ノード: 種別追加、%Z/X/R比テーブル差替え、R+jX分解式追加）
- [x] CLAUDE.md 更新（TR_RATINGS 記載更新、IMP_HV/Z_ZERO/WITHSTAND/ELCB 追記）
- [x] calcTransformer 関数: %Z+X/R比 → Rs+jXs ソースインピーダンス分解、定格電流、短絡電流、利用率
- [x] 変圧器編集フォーム（名称、種別、容量、一次/二次電圧、%Z、X/R比、結線方式）
- [x] 電圧継承: secondaryVoltage → 下位ノードの voltage 自動設定

#### P4-6: 短絡電流計算（LV 側 — R+jX ベクトル累積）

- [x] data/short-time-withstand.json 新規作成（K定数テーブル、I²t値）
- [x] scripts/build.js に short-time-withstand.json → WITHSTAND 注入追加
- [x] 仕様書更新（§20 R+jXベクトル累積方式に変更、§20-6 短時間耐電流検証 追加）
- [x] calcFaultCurrents: 変圧器 Rs+jXs を起点に R,X を独立累積、各ノード |Ztotal|→Isc₃ 算出
- [x] checkWithstand: ケーブル I²t 耐量 vs Isc₃²×t 検証
- [x] ResultPanel に利用可能短絡電流 Isc₃ + 熱耐量 OK/NG 表示追加
- [x] TreeTable に Isc₃ 列追加（オプション）

#### P4-7: HV 側データモデル準備

- [x] data/impedance-hv.json 新規作成（6600V CV-3C/CVT インピーダンス）
- [x] data/zero-sequence.json 新規作成（零相比、結線別乗数、地絡計算式）
- [x] data/elcb-specs.json 新規作成（ELCB感度電流・動作時間）
- [x] scripts/build.js に IMP_HV/Z_ZERO/C_CABLE/ELCB 注入追加
- [x] 仕様書更新（§19-5 HVケーブルインピーダンスフィールド追加、§20-7/20-8 将来実装節追加）
- [x] transformer ノードスキーマに hvSystem 予約フィールド追加（cableType, cableSize, totalCableLength_km, capacitance_uF_per_km）
- [x] HV ケーブルインピーダンスの LV 側換算（calcFaultCurrents 内でオプション使用）
- [x] Ig = 3ωCV 計算スタブ（コメントのみ）
- [x] M2-3 統合ポイントの明記

### P5: Import/Export＋PDF出力＋325×2

- [x] Export: 全ノードデータを JSON ダウンロード（version: P5）
- [x] Import: JSON ファイル読込、既存データに追記、ID衝突解決、旧形式メッセージ
- [x] PDF出力: 電-8-1 様式の電路計算書（A3横、HTML→印刷）
- [x] 親幹線行の太字・背景色区別
- [x] フッター注記（計算式、K値、判定基準）
- [x] 325×2 並列ケーブル対応（runCalc / runTrunkCalc / propagateFault / checkWithstand）

### P6: 検証・デプロイ

- [ ] 手計算との突合テスト（代表的な負荷パターン）
- [ ] エッジケース確認（最大/最小サイズ、全NG、単一回路等）
- [ ] 各ブラウザでの動作確認（Chrome / Edge / Firefox / Safari）
- [ ] オフライン動作確認
- [ ] GitHub Pages デプロイ・公開確認

---

## Milestone 2: 幹線系統図の自動生成

低圧幹線ケーブル計算ツールをベースに、高圧〜低圧を通貫した幹線系統図をインタラクティブに構築・表示する。

**アーキテクチャ**: モジュール配置型キャンバス。各幹線回路を入口/出口ポートを持つモジュールとして表現し、ユーザーがドラッグ操作で系統図を構築する。編集モード（配置・接続操作）とビューモード（系統図閲覧）の 2 モード。描画方向は横型（左→右）を実装。縦型（上→下）は拡張可能なフレームワーク。

| MS | 内容 | 概要 | 状態 |
|----|------|------|------|
| M2-1 | 複数幹線系統の統合管理 | 複数変圧器・モジュールデータモデル・系統メタデータ・Import/Export 拡張 | 完了 |
| M2-2 | 高圧系統のモデリング | 受電点から変圧器二次側までの高圧系統をデータモデル化する | 未着手 |
| M2-3 | 一線地絡電流の計算 | 高圧系統の対地静電容量から一線地絡電流を算出し、系統図上に反映する | 未着手 |
| M2-4 | 系統図描画エンジン | SVG キャンバス・モジュール描画・接続システム・自動配置・編集/ビューモード | 完了 |
| M2-5 | 系統図出力 | A3 横向き印刷用 HTML/SVG 出力・図面枠・標題欄・凡例 | 完了 |
| M2-6 | 幹線グループ管理 | グループ定義・クロスリンク・折りたたみ/展開・グループ単位出力 | 完了 |

### M2-1: 複数幹線系統の統合管理

- [x] M2-1-1: 複数変圧器サポート解放（`hasTr` 制約削除、`calcFaultCurrents` 全 TR ループ化）
- [x] M2-1-2: モジュールデータモデル（各ノードに `canvas: { x, y, width, height }` フィールド追加）
- [x] M2-1-3: 系統メタデータ（`systemMeta` ステート: 工事名称, HV 電圧, 周波数, 受電設備名, 描画方向）
- [x] M2-1-4: Import/Export スキーマ拡張（バージョン M2、`systemMeta` + `canvas` 座標の保存/復元）
- [x] M2-1-5: TreeTable の複数ルート対応（グループヘッダ表示、折りたたみ、クロスリンク表示）

### M2-4: 系統図描画エンジン

- [x] M2-4-1: キャンバス基盤（`DiagramCanvas` コンポーネント: パン＆ズーム対応 SVG キャンバス）
- [x] M2-4-2: モジュール描画コンポーネント群（`ModuleTransformer`, `ModuleTrunk`, `ModuleLoadNode`）
- [x] M2-4-3: 電気シンボルライブラリ（`SvgTransformer`, `SvgMCCB`, `SvgMotor`, `SvgLoad`, `SvgBusBar`, `SvgPort`, `SvgVCB`）
- [x] M2-4-4: 接続システム（ベジェ曲線接続線 + ポートドラッグで `parentId` 連動 + 階層バリデーション）
- [x] M2-4-5: 編集モード（モジュールドラッグ移動、ポート接続操作、グリッド表示）
- [x] M2-4-6: ビューモード（編集 UI 非表示、アノテーション全表示、パン＆ズームのみ）
- [x] M2-4-7: 描画方向フレームワーク（`DIRECTIONS` オブジェクト: horizontal/vertical 抽象化。今回は horizontal のみ実装）
- [x] M2-4-8: 自動配置（`autoLayout`: ツリー構造から交差軸サイズ計測→再帰座標割り当て）
- [x] M2-4-9: UI 統合（右ペインに [テーブル] / [系統図] / [分割] タブ + 編集/ビューモード切替ボタン）

### M2-5: 系統図出力

- [x] M2-5-1: 印刷用 HTML/SVG 生成（`genDiagramHTML`: A3 横向き、viewBox スケーリング）
- [x] M2-5-2: 図面枠・標題欄（右下: 幹線系統図タイトル、工事名称、作成日）
- [x] M2-5-3: アノテーション全表示（変圧器: 容量/%Z/Isc₃、MCCB: AT、ケーブル: 種類/サイズ/こう長、負荷: 名称/電流/Vd%）
- [x] M2-5-4: ヘッダーに「系統図」ボタン追加（`window.open` + `document.write` パターン）
- [x] M2-5-5: 凡例・注記セクション（MCCB、変圧器、電動機、一般負荷のシンボル説明）

### M2-2: 高圧系統のモデリング（未着手）

- [ ] M2-2-1: `cable-capacitance.json` に実データ投入（技資第 103 号 A）
- [ ] M2-2-2: 変圧器フォームに `hvSystem` セクション追加（HV ケーブル種別/サイズ/こう長/静電容量）
- [ ] M2-2-3: HV インピーダンス LV 換算コードの活性化（`calcFaultCurrents` 内コメント解除）
- [ ] M2-2-4: HV 受電点モデル（`systemMeta.sourceImpedance`、電力会社供給インピーダンス）
- [ ] M2-2-5: VCB/LBS モデリング（アノテーション用、インピーダンス寄与なし）

### M2-3: 一線地絡電流の計算（未着手）

- [ ] M2-3-1: HV 側地絡電流（`Ig = 3ωCV`）の実装
- [ ] M2-3-2: LV 側地絡電流（対称座標法: `Ig = 3Ea / (2Z₁ + Z₀)`）
- [ ] M2-3-3: ELCB 保護協調チェック（`RA × IΔn ≤ 50V`）
- [ ] M2-3-4: B 種接地抵抗計算（`R_B ≤ 150/Ig` or `600/Ig`）
- [ ] M2-3-5: 地絡電流計算結果の UI 表示

### M2-6: 幹線グループ管理

- [x] M2-6-G1: データモデル基盤（`groups[]`, `crossLinks[]` ステート、ユーティリティ関数、自動グループ作成、CRUD ハンドラ、Export/Import M2G スキーマ）
- [x] M2-6-G2: TreeTable グループ表示（グループヘッダ行、折りたたみ、クロスリンクインジケータ、未分類セクション）
- [x] M2-6-G3: グループ編集 UI（`GroupEditor` コンポーネント、左ペイン「グループ」タブ、名称/色編集、クロスリンク追加/削除）
- [x] M2-6-G4: キャンバス展開グループ描画（`GroupContainer` 背景枠、グループ名ラベル、描画順序更新）
- [x] M2-6-G5: キャンバス折りたたみグループ（`ModuleGroupCollapsed` サマリーボックス、折りたたみ時ノード非表示）
- [x] M2-6-G6: クロスリンク描画（キャンバス上ベジェ曲線、ラベル表示、線種/色対応）
- [x] M2-6-G7: グループ単位出力（`OutputDropdown` コンポーネント、PDF/系統図ボタンにドロップダウン、グループフィルタ対応）
- [x] M2-6-G8: 整合性チェック（ノード/グループ連動削除、変圧器名同期更新）
